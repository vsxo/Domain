<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>On-Chain Live Crypto Terminal</title>
    <!-- Link to the manifest.json for PWA functionality (if you create one) -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define base theme variables */
        :root {
            --bg: #1E2329;
            /* Binance Dark Grey */
            --card: #0B0E11;
            /* Even darker for cards/inner elements */
            --muted: #848E9C;
            /* Muted grey for text */
            --accent: #FCD535;
            /* Binance Yellow */
            --glass: rgba(255, 255, 255, 0.03);
            --border: #333333;
            /* Border color for elements */
        }

        /* Dark Theme Specific Overrides (CoinStats-like) */
        body.dark {
            background-color: #0d111c; /* Deeper dark blue-gray */
            color: #e2e8f0; /* Light gray for text */
            --bg: #0d111c;
            --card: #1a202c; /* Slightly lighter dark for cards */
            --muted: #94a3b8; /* Muted light gray */
            --accent: #60a5fa; /* Blue accent for primary actions/links */
            --border: #2d3748; /* Darker border */
            --button-bg: #3b82f6; /* Blue button background */
            --button-hover-bg: #2563eb; /* Darker blue on hover */
            --secondary-button-bg: #2d3748; /* Dark gray for secondary buttons */
            --secondary-button-hover-bg: #4a5568; /* Lighter dark gray on hover */
            --input-bg: #1a202c;
            --input-border: #2d3748;
            --text-color: #e2e8f0;
            --header-bg: #1a202c;
        }

        /* Light Theme Specific Overrides */
        body.light {
            background-color: #f3f3f3;
            color: #111;
            --bg: #f3f3f3;
            --card: #ffffff;
            --muted: #666;
            --accent: #facc15;
            --border: #ccc;
            --button-bg: #facc15;
            --button-hover-bg: #f5d72f;
            --secondary-button-bg: #e0e0e0;
            --secondary-button-hover-bg: #d0d0d0;
            --input-bg: #ffffff;
            --input-border: #ccc;
            --text-color: #111;
            --header-bg: #ffffff;
        }

        /* General Body and HTML styles */
        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
            /* Smooth theme transition */
        }

        /* Card styles */
        .card {
            background-color: var(--card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        body.light .card {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        /* Muted text color */
        .muted {
            color: var(--muted);
        }

        /* Button styles */
        .btn {
            background-color: var(--secondary-button-bg);
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            color: var(--text-color);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .btn:hover {
            background-color: var(--secondary-button-hover-bg);
            border-color: var(--secondary-button-hover-bg); /* Or darker shade */
        }

        /* Accent button style (Blue for CoinStats theme) */
        .accent {
            background: var(--accent);
            color: #000000;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .accent:hover {
            background: var(--button-hover-bg);
        }
        body.light .accent {
            color: #111;
        }

        /* Monospace font for prices/hashes */
        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
        }

        /* Small text size */
        .small {
            font-size: 13px;
        }

        /* Logo styling */
        .logo-sq {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        /* Toast notifications (currently using modal) */
        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 22px;
            z-index: 9999;
            padding: 10px 14px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            color: white;
            font-size: 14px;
        }

        /* Select and input field styles */
        select,
        input {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            padding: 10px;
            border-radius: 8px;
            color: var(--text-color);
            outline: none;
        }

        select:focus,
        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
        }

        /* Bottom navigation bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: var(--header-bg); /* Use header background for consistency */
            color: var(--text-color);
            padding: 6px 0;
            z-index: 50;
            border-top: 1px solid var(--border);
        }

        .bottom-nav .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s;
            padding: 6px 8px;
            border-radius: 8px;
        }

        .bottom-nav .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        body.light .bottom-nav .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .bottom-nav .nav-item svg {
            width: 20px;
            height: 20px;
            margin-bottom: 2px;
        }

        .bottom-nav .active {
            color: var(--accent);
        }

        /* Horizontal scrollable row */
        .scroll-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .scroll-row::-webkit-scrollbar {
            display: none;
        }

        /* Pill shape elements */
        .pill {
            border-radius: 999px;
        }

        /* Icon opacity */
        .icon {
            opacity: .9;
        }

        /* Quick action grid for home page */
        .quick-action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            text-align: center;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            border-radius: 8px;
            background-color: var(--secondary-button-bg);
            color: var(--text-color);
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid var(--border);
        }

        .quick-action-btn:hover {
            background-color: var(--secondary-button-hover-bg);
        }

        .quick-action-btn .icon-lg {
            font-size: 24px;
            margin-bottom: 4px;
            color: var(--accent);
        }

        /* Custom modal for messages */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            color: var(--text-color);
        }

        .modal-content select,
        .modal-content input {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
        }

        .modal-content button {
            background-color: var(--secondary-button-bg);
            color: var(--text-color);
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .modal-content button:hover {
            background-color: var(--secondary-button-hover-bg);
            border-color: var(--secondary-button-hover-bg);
        }

        .close-button {
            color: var(--muted);
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-color);
            text-decoration: none;
        }

        /* Keyframe animation for modal */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ticker specific styles */
        #ticker {
            overflow: hidden;
            white-space: nowrap;
            padding: 6px 0;
            display: flex;
            align-items: center;
            background-color: var(--card);
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        #ticker span {
            display: inline-flex;
            align-items: center;
            padding: 0 20px;
            font-size: 0.875rem;
        }

        #ticker img {
            width: 18px;
            height: 18px;
            margin-right: 6px;
        }

        /* Coin card hover effect */
        .coin-card:hover {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }

        .coin-logo {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        /* Favorite icon styles */
        .favorite {
            color: #facc15;
            cursor: pointer;
        }

        .not-favorite {
            color: #888;
            cursor: pointer;
        }

        /* Trade screen panels */
        .order-book,
        .recent-trades,
        .trade-panel {
            background-color: var(--card);
            padding: 16px;
            border-radius: 12px;
            overflow: auto;
            max-height: 250px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        /* Trade panel input styles */
        .trade-panel input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        /* Trade panel button styles */
        .trade-panel button {
            width: 48%;
            padding: 10px 14px;
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .trade-panel button.buy {
            background-color: #22c55e;
        }

        .trade-panel button.buy:hover {
            background-color: #16a34a;
        }

        .trade-panel button.sell {
            background-color: #ef4444;
        }

        .trade-panel button.sell:hover {
            background-color: #dc2626;
        }

        /* Responsive container */
        @media (min-width: 720px) {
            .container {
                max-width: 920px;
                margin: 18px auto;
            }

            .bottom-nav {
                display: none;
            }

            .app-container {
                padding-bottom: 20px;
            }
        }

        /* Page visibility */
        .page {
            display: none;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        .page.active {
            display: block;
        }

        /* Merged Market Overview Specific Styles */
        #marketBox {
            background-color: var(--card);
        }

        #marketBox .grid-cols-4 {
            border-bottom: 1px solid var(--border);
        }

        #coinsList > div {
            border-bottom: 1px solid var(--border);
        }

        #coinsList > div:last-child {
            border-bottom: none;
        }

        #coinsList > div:hover {
            background-color: rgba(255, 255, 255, 0.05); /* Lighter hover for dark theme */
        }
        body.light #coinsList > div:hover {
            background-color: rgba(0, 0, 0, 0.03); /* Darker hover for light theme */
        }
        .price-up {
            color: #38a169; /* Green */
        }
        .price-down {
            color: #e53e3e; /* Red */
        }

        /* Landing page styles - Updated for CoinStats Look */
        #landing-page {
            display: none; /* Hidden by default, shown by JS */
            width: 100%;
            min-height: 100vh;
            background-color: #0d111c; /* CoinStats dark mode bg */
            color: #e2e8f0; /* Light gray for text */
            position: relative;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            padding-bottom: 3rem; /* Space for PWA button if shown at bottom */
        }
        #landing-page .hero-section {
            position: relative;
            min-height: 80vh; /* Adjusted for content below */
            display: flex;
            flex-direction: column; /* Stack content */
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            overflow: hidden;
        }
        #landing-page .hero-bg {
            position: absolute;
            inset: 0;
            background-image: url('https://placehold.co/1920x1080/0d111c/ffffff?text=Crypto+Background'); /* Placeholder, could be abstract pattern */
            background-size: cover;
            background-position: center;
            opacity: 0.2;
        }
        #landing-page .hero-content {
            position: relative;
            z-index: 10;
            max-width: 56rem; /* max-w-4xl */
            margin: auto;
            padding-top: 4rem; /* Add padding to top for header */
        }
        #landing-page h1 {
            font-size: 3.75rem; /* text-5xl md:text-7xl */
            font-weight: 800; /* font-extrabold */
            line-height: 1.25; /* leading-tight */
            margin-bottom: 1rem;
            color: #60a5fa; /* text-blue-400 */
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.25)); /* drop-shadow-lg */
        }
        #landing-page p {
            font-size: 1.25rem; /* text-xl md:text-2xl */
            color: #d1d5db; /* text-gray-300 */
            margin-bottom: 2rem;
        }
        #landing-page button.landing-cta {
            background-color: var(--button-bg);
            color: #ffffff;
            font-weight: 700; /* font-bold */
            padding: 0.75rem 2rem; /* py-3 px-8 */
            border-radius: 9999px; /* rounded-full */
            font-size: 1.25rem; /* text-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transform: scale(1);
            transition: transform 0.3s ease-in-out;
            outline: none;
            cursor: pointer;
        }
        #landing-page button.landing-cta:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.05);
        }
        #landing-page button.landing-cta:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); /* focus:ring-4 focus:ring-blue-500 focus:ring-opacity-75 */
        }
        #landing-page section {
            padding: 4rem 1rem; /* py-16 px-4 */
        }
        #landing-page .bg-gray-900-coinstats {
            background-color: #1a202c; /* Card background in CoinStats theme */
        }
        #landing-page .bg-gray-950-coinstats {
            background-color: #0d111c; /* Main background in CoinStats theme */
        }
        #landing-page h2 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            text-align: center;
            margin-bottom: 3rem;
            color: #93c5fd; /* text-blue-300 */
        }
        #landing-page .feature-card {
            background-color: var(--card); /* CoinStats card bg */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            border: 1px solid var(--border); /* CoinStats border */
            transform: scale(1);
            transition: transform 0.3s ease-in-out;
        }
        #landing-page .feature-card:hover {
            transform: scale(1.05);
        }
        #landing-page .feature-icon {
            font-size: 3.125rem; /* text-5xl */
            margin-bottom: 1rem;
        }
        #landing-page .feature-card h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.75rem;
        }
        #landing-page .feature-card p {
            font-size: 1rem;
            color: #d1d5db;
        }
        #landing-page .how-it-works-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            #landing-page .how-it-works-item {
                flex-direction: row;
                text-align: left;
            }
        }
        #landing-page .step-number {
            font-size: 3.75rem; /* text-6xl */
            color: #3b82f6; /* text-blue-500 */
            font-weight: 800; /* font-extrabold */
            margin-bottom: 1.5rem; /* mb-6 md:mb-0 */
            flex-shrink: 0;
        }
        #landing-page .team-member {
            background-color: var(--card); /* CoinStats card bg */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
            border: 1px solid var(--border);
        }
        #landing-page .team-img {
            border-radius: 9999px;
            margin: auto;
            margin-bottom: 1rem;
            width: 6rem;
            height: 6rem;
            object-fit: cover;
        }
        #landing-page .team-member h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }
        #landing-page .team-member .role {
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }
        #landing-page .team-member p {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        #landing-page .faq-item {
            background-color: var(--card); /* CoinStats card bg */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }
        #landing-page .faq-item summary {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            transition: color 0.2s;
        }
        #landing-page .faq-item summary:hover {
            color: #60a5fa;
        }
        #landing-page .faq-item p {
            margin-top: 0.75rem;
            color: #d1d5db;
        }
        #landing-page footer {
            background-color: #0d111c; /* CoinStats dark mode bg */
            padding: 2.5rem 1rem;
            text-align: center;
            color: #9ca3af;
            font-size: 0.875rem;
        }
        #landing-page footer a {
            color: #9ca3af;
            transition: color 0.2s;
        }
        #landing-page footer a:hover {
            color: #ffffff;
        }
        /* CoinStats-like specific market table styles for landing page */
        #landingMarketOverview {
            background-color: var(--card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            margin-top: 4rem;
        }
        #landingMarketOverview .table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--muted);
        }
        #landingMarketOverview .coin-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        #landingMarketOverview .coin-row:last-child {
            border-bottom: none;
        }
        #landingMarketOverview .coin-row:hover {
            background-color: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
        }
        #landingMarketOverview .coin-info {
            display: flex;
            align-items: center;
        }
        #landingMarketOverview .coin-info img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 0.75rem;
        }
        #landingMarketOverview .coin-name {
            font-weight: 500;
            color: var(--text-color);
        }
        #landingMarketOverview .coin-symbol {
            font-size: 0.875rem;
            color: var(--muted);
            text-transform: uppercase;
        }
        #landingMarketOverview .price {
            text-align: right;
            font-weight: 500;
            color: var(--text-color);
        }
        #landingMarketOverview .change {
            text-align: right;
            font-weight: 500;
        }
        .green-text { color: #22c55e; } /* Tailwind green-500 */
        .red-text { color: #ef4444; }   /* Tailwind red-500 */

        /* PWA Install Button on Landing Page */
        #landing-pwa-install-btn {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background-color: var(--accent);
            color: #000;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none; /* Hidden by default, shown when deferredPrompt is available */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            white-space: nowrap;
        }
        #landing-pwa-install-btn:hover {
            background-color: var(--button-hover-bg);
            transform: translateX(-50%) scale(1.05);
        }
    </style>
    <!-- External JavaScript Libraries for WalletConnect and Web3 functionalities -->
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module">
        // Firebase imports (using type="module" for Firebase ESM)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL CONFIGURATION
        const CONFIG = {
            INFURA_ID: "c35d1ef971da479b918c9900134867d4",
            ETHERSCAN_API: "0338f3b98ad211aef5de661cba3f0ead0981460048cfabeee506cdd58a298204",
            BSCSCAN_API: "ZM8ACMJB67C2IXKKBF8URFUNSY",
            MORALIS_API: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6ImUzZmNjNmVlLTVmYTItNGI5OC1hYzAwLTVjNjJlOGI4NTVmNiIsIm9yZ0lkIjoiNDY1MjI1IiwidXNlcklkIjoiNDc4NjE5IiwidHlwZUlkIjoiYmZmYTEwYzctMjQ4MC1hYzAwLTVjNjJlOGI4NTVmNiIsImlhdCI6MTc1NTIyNjU0OCwiZXhwIjo0OTEwOTg2NTQ4fQ.Z0-grx3kR0tfWAt8qbkt5xlgvBGsXuybm5j05ZwK0Tc",
            SNOWSCAN_API: "ATJQERBKV1CI3GVKNSE3Q7RGEJ",
            ARBISCAN_API: "B6SVGA7K3YBJEQ69AFKJF4YHVX",
            OPTIMISM_API: "66N5FRNV1ZD4I87S7MAHCJVXFJ",
            SIGN_PROJECT_ID: "cedd3cec8430b2990ce3fe466ecb1a29",
            SERVER_BASE: "", // Placeholder for server API, if any
            COINGECKO_API_BASE: "https://api.coingecko.com/api/v3",
        };

        // CONSTANTS for deposit addresses and USDT contracts
        const DEPOSIT = {
            ETH: "0xAB98294614C46008cBF82Fa3e25285FBC2A6F257",
            BSC: "0xAB98294614C46008cBF82Fa3e25285FBC2A6F257",
            POLYGON: "0xAB98294614C46008cBF82Fa3e25285FBC2A6F257",
            ARBITRUM: "0xAB98294614C46008cBF82Fa3e25285FBC2A6F257",
            OPTIMISM: "0xAB98294614C46008cBF82Fa3e25285FBC2A6F257",
            AVAX: "0xAB98294614C46008cBF82Fa3e25285FBC2A6F257",
            SOL: "GwobMFEUFxPH3kfpHjbyCsKcVaPV4ptAePEPdnpHdmn5",
            BTC: "bc1q9ldrkd44xk9xlg3qgefx5avhl7hwlfaqaktsmx"
        };

        const USDT_CONTRACTS = {
            ETH: "0xdAC17F958D2ee523a2206206994597C13D831ec7", // ERC20 (6)
            BSC: "0x55d398326f99059fF775485246999027B3197955", // BEP20 (18)
            POLYGON: "0xc2132D05D31c914a87C6611C10748AaCBbDE971B6",
            ARBITRUM: "0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9",
            OPTIMISM: "0x94b008aA00579c1307B0EF2c499aD98a8ce58e58",
            AVAX: "0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7"
        };

        const ERC20_ABI = [
            { "constant": false, "inputs": [{ "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "transfer", "outputs": [{ "name": "", "type": "bool" }], "type": "function" },
            { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "", "type": "bool" }], "type": "function" },
            { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }, { "name": "_spender", "type": "address" }], "name": "allowance", "outputs": [{ "name": "", "type": "uint256" }], "type": "function" },
            { "constant": true, "inputs": [], "name": "decimals", "outputs": [{ "name": "", "type": "uint8" }], "type": "function" },
            { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" }
        ];

        // --- GLOBAL VARIABLES ---
        let cachedData = [];
        let previousPrices = {}; // For flashing price changes
        let favorites = new Set(); // Not actively used but kept for future features
        let page = 1; // Current page for CoinGecko market data
        let perPage = 20;
        let body; // Reference to the document body
        let ticker; // Reference to the market ticker element
        let searchInput; // Reference to the search input on the market screen
        let marketScreen; // Reference to the market overview screen
        let tradeScreen; // Reference to the trade screen
        let screenTitle; // Reference to the header title
        let selectedCoin = null; // Currently selected coin for trading view

        // Live Crypto Terminal Data (Binance mock data)
        const BINANCE_WS_BASE = 'wss://stream.binance.com:9443/ws/';
        const BINANCE_REST_BASE = 'https://api.binance.com/api/v3/';
        let currentPair = 'BTCUSDT'; // Default pair for trade screen (e.g., BTCUSDT, ETHUSDT)
        let lastPrice = null; // Last price for trade screen updates
        let prevOrderBook = { bids: {}, asks: {} }; // Previous order book state for flashing
        let latestDepth = { bids: [], asks: {} }; // Latest order book data
        let latestTrades = []; // Latest trade history
        let tradeWindow = []; // For VWAP calculation (Volume Weighted Average Price)
        let priceHistory = []; // For Lightweight Chart data
        let depthSocket = null, tradeSocket = null, httpTimer = null;
        let httpIntervalMs = 3000; // Interval for HTTP polling fallback
        let wsFailures = 0, wsBackoff = 1000, wsBackoffMax = 15000; // WebSocket reconnection strategy

        // UI Element References (will be assigned in DOMContentLoaded)
        let messageModal, modalMessage, closeModalButton, copyModalMessageButton; // General purpose modal
        let networkSwitchModal, networkSwitchSelect, confirmNetworkSwitchButton, closeNetworkSwitchModalButton; // Network switch modal
        let pages = {}; // Dictionary to hold references to all main page sections
        let depositSection; // Deposit section on the wallet page
        let btnConnect, btnSettings; // Header buttons
        let landingPWAInstallBtn; // PWA Install button on landing page
        // Send page elements
        let allowanceBtn, approveBtn, approveMaxBtn, gasBtn, sendBtn, sendChain, recipient, amount, sendMsg, feeBox;
        // Deposit page elements
        let depositBtns, depositQR, depositLabel, depositAddr, copyDepositBtn, explorerDepositBtn;
        // Futures simulation elements
        let runSimBtn, simResult;
        // Withdraw page elements
        let wdAmount, wdNet, wdCoin, wdCoin2, wdConfirmBtn, wdConfirm, wdProcessing, wdTxHash, wdVerifyBtn, wdMsg, wdCountdown, wdHomeBtn, wdBackHome, totalUsdtEl, totalUsdtWithdrawEl;
        let withdrawalCountdownInterval; // Interval for withdrawal countdown
        let web3 = null; // Web3.js instance for wallet interactions
        let wcProviderInstance = null; // WalletConnect provider instance
        let connectedAccount = null; // Connected wallet address
        let connectedChainId = null; // Connected chain ID
        let deferredPrompt; // For PWA installation prompt
        let currentWalletType = null; // To track if mobile or browser wallet is connected for network switch
        let currentDepositNetwork = 'ETH'; // Currently selected deposit network
        // Wallet connection modal elements (from previous `a5a86fb44eb4` link)
        let landingPage, appContainer; // Main page containers
        let landingConnectWalletBtn, ctaConnectWalletBtn; // Buttons on the landing page
        let showMobileConnectBtn, showBrowserConnectBtn, showManualConnectBtn; // Tabs in the wallet connect modal
        let mobileConnectSection, browserConnectSection, manualConnectSection; // Sections for each connection type
        let connectMobileButton, mobileConnectStatus, mobileConnectedInfo, mobileWalletAddressSpan, mobileWalletNetworkSpan, mobileWalletChainIdSpan, switchNetworkMobileButton, disconnectMobileButton, mobileLoadingSpinner;
        let connectBrowserButton, browserConnectStatus, browserConnectedInfo, browserWalletAddressSpan, browserWalletNetworkSpan, browserWalletChainIdSpan, switchNetworkBrowserButton, disconnectBrowserButton, browserLoadingSpinner;
        let manualConnectNote, networkSelect, walletAddressInput, addressInputContainer, fetchBalanceButton, manualConnectionInfo, manualNetworkDisplay, manualAddressDisplay, manualBalanceDisplay, viewWalletButton, manualLoadingSpinner;
        let lightweightChartInstance = null; // Lightweight Charts instance for trade screen
        let candleSeries = null; // Candlestick series for lightweightChart
        let statusBox, marketBox, coinsList, loadMoreBtn; // Market overview elements (added loadMoreBtn here)
        let orderBookDiv, recentTradesDiv, tradePriceDisplay, tradePairDisplay; // Trade screen elements
        let walletConnectionModal; // Reference to the wallet connection modal
        let landingMarketOverview; // Element for market overview on landing page
        let landingMarketList; // Element for coins list within landingMarketOverview

        // --- Network Configurations for wallet-connector page ---
        const networks = [
            { id: 'eth_mainnet', name: 'Ethereum Mainnet', type: 'evm', chainId: '0x1', symbol: 'ETH', rpc: `https://mainnet.infura.io/v3/${CONFIG.INFURA_ID}`, explorerUrl: 'https://etherscan.io/address/' },
            { id: 'eth_ropsten', name: 'Ropsten Testnet', type: 'evm', chainId: '0x3', symbol: 'ETH', rpc: `https://ropsten.infura.io/v3/${CONFIG.INFURA_ID}`, explorerUrl: 'https://ropsten.etherscan.io/address/' },
            { id: 'eth_rinkeby', name: 'Rinkeby Testnet', type: 'evm', chainId: '0x4', symbol: 'ETH', rpc: `https://rinkeby.infura.io/v3/${CONFIG.INFURA_ID}`, explorerUrl: 'https://rinkeby.etherscan.io/address/' },
            { id: 'eth_goerli', name: 'Goerli Testnet', type: 'evm', chainId: '0x5', symbol: 'ETH', rpc: `https://goerli.infura.io/v3/${CONFIG.INFURA_ID}`, explorerUrl: 'https://goerli.etherscan.io/address/' },
            { id: 'bsc_mainnet', name: 'BNB Smart Chain', type: 'evm', chainId: '0x38', symbol: 'BNB', rpc: 'https://bsc-dataseed1.binance.org', explorerUrl: 'https://bscscan.com/address/' },
            { id: 'polygon_mainnet', name: 'Polygon Mainnet', type: 'evm', chainId: '0x89', symbol: 'MATIC', rpc: 'https://polygon-rpc.com/', explorerUrl: 'https://polygonscan.com/address/' },
            { id: 'avax_c_chain', name: 'Avalanche C-Chain', type: 'evm', chainId: '0xA86A', symbol: 'AVAX', rpc: 'https://api.avax.network/ext/bc/C/rpc', explorerUrl: 'https://snowtrace.io/address/' },
            { id: 'arbitrum_one', name: 'Arbitrum One', type: 'evm', chainId: '0xA4B1', symbol: 'ETH', rpc: 'https://arb1.arbitrum.io/rpc', explorerUrl: 'https://arbiscan.io/address/' },
            { id: 'optimism_mainnet', name: 'Optimism Mainnet', type: 'evm', chainId: '0xA', symbol: 'ETH', rpc: 'https://mainnet.optimism.io', explorerUrl: 'https://optimistic.etherscan.io/address/' },
            { id: 'fantom_mainnet', name: 'Fantom Opera', type: 'evm', chainId: '0xfa', symbol: 'FTM', rpc: 'https://rpc.ftm.tools/', explorerUrl: 'https://ftmscan.com/address/' },
            { id: 'btc', name: 'Bitcoin (BTC)', type: 'non-evm', symbol: 'BTC', api: 'https://api.blockcypher.com/v1/btc/main/addrs/', explorerUrl: 'https://blockchair.com/bitcoin/address/' },
            { id: 'tron', name: 'TRON (TRX)', type: 'non-evm', symbol: 'TRX', api: 'https://api.trongrid.io/wallet/getaccount', explorerUrl: 'https://tronscan.org/#/address/' },
            { id: 'solana', name: 'Solana (SOL)', type: 'non-evm', symbol: 'SOL', rpc: 'https://api.mainnet-beta.solana.com', explorerUrl: 'https://solscan.io/address/' },
            { id: 'polkadot', name: 'Polkadot (DOT)', type: 'non-evm', symbol: 'DOT', api: 'N/A', explorerUrl: 'https://polkadot.subscan.io/account/' },
            { id: 'cardano', name: 'Cardano (ADA)', type: 'non-evm', symbol: 'ADA', api: 'N/A', explorerUrl: 'https://explorer.cardano.org/en/address/' },
        ];

        // Helper to map numeric chainId to short key (e.g., 1 -> 'ETH')
        function getChainKeyFromChainId(id) {
            const network = networks.find(n => n.type === 'evm' && parseInt(n.chainId, 16) === id);
            return network ? network.id.split('_')[0].toUpperCase() : null;
        }

        /* ====== Navigation & Page Management ====== */
        function navigateToPage(pageId) {
            // Hide all primary page sections
            [marketScreen, tradeScreen, ...Object.values(pages)].forEach(p => p && p.classList.remove('active'));

            let targetPageElement;

            if (pageId === 'market') {
                targetPageElement = marketScreen;
                screenTitle.textContent = 'Markets';
                destroyTradeChart(); // Destroy chart if navigating away from trade
                loadMarket(); // Reload market data for the market screen
            } else if (pageId === 'trade') {
                targetPageElement = tradeScreen;
                screenTitle.textContent = 'Trade';
                // Set default selected coin if none is set, for trade screen
                if (!selectedCoin && cachedData.length > 0) {
                    selectedCoin = cachedData[0]; // Default to the top coin
                    currentPair = `${selectedCoin.symbol.toUpperCase()}USDT`;
                } else if (!selectedCoin) { // Fallback if no data at all
                     selectedCoin = { symbol: 'BTC', sparkline_in_7d: { price: [] } };
                     currentPair = 'BTCUSDT';
                }
                setPair(currentPair); // Start WebSocket for trade data via setPair
                initializeAndRenderTradeChart(); // Initialize and update the Lightweight chart
            } else {
                targetPageElement = pages[pageId];
                // Set screen title based on the pageId
                const titleMap = {
                    'wallet': 'Wallet', 'send': 'Send Crypto', 'earn': 'Earn', 'convert': 'Convert',
                    'p2p': 'P2P Trading', 'pay': 'Binance Pay', 'more': 'More Services', 'news': 'News',
                    'academy': 'Academy', 'launchpad': 'Launchpad', 'cards': 'Crypto Cards',
                    'withdraw': 'Withdraw', 'settings': 'Settings', 'help': 'Help', 'chat': 'Live Chat',
                    'connect': 'Connect Wallet', 'futures': 'Futures'
                };
                screenTitle.textContent = titleMap[pageId] || 'OnChain';
                destroyTradeChart(); // Destroy chart if navigating away from trade
            }

            if (targetPageElement) {
                targetPageElement.classList.add('active');
                if (pageId === 'wallet') {
                    if (depositSection) {
                        depositSection.style.display = 'block';
                        updateDepositUI(currentDepositNetwork);
                    }
                } else if (depositSection) {
                    depositSection.style.display = 'none';
                }

                // Reset withdrawal pages display when navigating away from them
                if (pageId !== 'withdraw') {
                    const wdConfirmEl = document.getElementById('wdConfirm');
                    const wdProcessingEl = document.getElementById('wdProcessing');
                    const wdFirstCard = document.querySelector('#page-withdraw .card:first-of-type');
                    if (wdConfirmEl) wdConfirmEl.style.display = 'none';
                    if (wdProcessingEl) wdProcessingEl.style.display = 'none';
                    if (wdFirstCard) wdFirstCard.style.display = 'block';
                    if (withdrawalCountdownInterval) {
                        clearInterval(withdrawalCountdownInterval);
                        withdrawalCountdownInterval = null;
                    }
                }
            } else {
                console.warn(`Page with ID '${pageId}' not found. Falling back to Markets.`);
                if (marketScreen) marketScreen.classList.add('active');
                screenTitle.textContent = 'Markets';
                destroyTradeChart(); // Destroy chart if falling back to market
            }

            // Update bottom navigation active state
            document.querySelectorAll('.bottom-nav .nav-item').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.nav === pageId || (['send', 'earn', 'convert', 'p2p', 'pay', 'withdraw', 'connect'].includes(pageId) && button.dataset.nav === 'wallet')) {
                    button.classList.add('active');
                }
            });

            // Specific logic for page activation/deactivation
            if (pageId === 'trade') {
                setPair(currentPair); // Start WebSocket for trade data via setPair
                initializeAndRenderTradeChart(); // Initialize and update the Lightweight chart
            } else {
                stopAll(); // Stop WebSockets and HTTP polling if not on trade page
            }
            if (pageId === 'chat') {
                loadSmartsuppChat();
            } else {
                unloadSmartsuppChat();
            }
        }

        // --- Utility Functions for Custom Modal ---
        function showMessageModal(msg, title = 'Notification') {
            if (modalMessage) modalMessage.textContent = msg;
            if (messageModal) messageModal.style.display = 'flex';
        }

        function hideModal() {
            if (modalMessage) modalMessage.textContent = '';
            if (messageModal) messageModal.style.display = 'none';
        }

        function showNetworkSwitchModal(walletType) {
            currentWalletType = walletType;
            if (networkSwitchSelect) {
                networkSwitchSelect.innerHTML = '<option value="">Select a Network</option>';
                networks.filter(net => net.type === 'evm').forEach(network => {
                    const option = document.createElement('option');
                    option.value = network.chainId;
                    option.textContent = network.name;
                    networkSwitchSelect.appendChild(option);
                });
            }
            if (networkSwitchModal) networkSwitchModal.style.display = 'flex';
        }

        function hideNetworkSwitchModal() {
            if (networkSwitchModal) networkSwitchModal.style.display = 'none';
            currentWalletType = null;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /* ====== Live Crypto Terminal Functions (Adapted for new UI) ====== */

        function renderOrderBook(ob) {
            if (!orderBookDiv) return;
            orderBookDiv.innerHTML = '';
            const topBids = (ob.bids || []).slice(0, 12);
            const topAsks = (ob.asks || []).slice(0, 12);
            const maxBidQty = Math.max(1e-12, ...topBids.map(x => parseFloat(x[1]) || 0));
            const maxAskQty = Math.max(1e-12, ...topAsks.map(x => parseFloat(x[1]) || 0));

            // Display asks (reversed to show lowest asks at top)
            topAsks.slice().reverse().forEach(([price, qty]) => {
                const p = parseFloat(price).toFixed(4);
                const q = parseFloat(qty).toFixed(4);
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center py-0.5 px-1 relative';
                const bar = document.createElement('div');
                bar.className = 'absolute top-0 left-0 bottom-0 bg-red-500 opacity-20 rounded-sm';
                bar.style.width = `${(parseFloat(qty) / maxAskQty) * 100}%`;
                row.appendChild(bar);
                const inner = document.createElement('div');
                inner.className = 'flex justify-between w-full relative z-10';
                inner.innerHTML = `<div class="mono text-red-400 font-semibold">${p}</div><div class="mono text-gray-400">${q}</div>`;
                row.appendChild(inner);
                orderBookDiv.appendChild(row);
                if (prevOrderBook.asks[p] !== undefined && parseFloat(prevOrderBook.asks[p]) !== parseFloat(q)) {
                    flashRow(row, parseFloat(prevOrderBook.asks[p]), parseFloat(q), 'red');
                }
                prevOrderBook.asks[p] = q;
            });

            const currentPriceSeparator = document.createElement('div');
            currentPriceSeparator.className = 'text-center text-xl font-bold my-1 text-yellow-400';
            currentPriceSeparator.textContent = lastPrice ? parseFloat(lastPrice).toFixed(4) : '--.--';
            orderBookDiv.appendChild(currentPriceSeparator);

            // Display bids
            topBids.forEach(([price, qty]) => {
                const p = parseFloat(price).toFixed(4);
                const q = parseFloat(qty).toFixed(4);
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center py-0.5 px-1 relative';
                const bar = document.createElement('div');
                bar.className = 'absolute top-0 right-0 bottom-0 bg-green-500 opacity-20 rounded-sm';
                bar.style.width = `${(parseFloat(qty) / maxBidQty) * 100}%`;
                row.appendChild(bar);
                const inner = document.createElement('div');
                inner.className = 'flex justify-between w-full relative z-10';
                inner.innerHTML = `<div class="mono text-green-400 font-semibold">${p}</div><div class="mono text-gray-400">${q}</div>`;
                row.appendChild(inner);
                orderBookDiv.appendChild(row);
                if (prevOrderBook.bids[p] !== undefined && parseFloat(prevOrderBook.bids[p]) !== parseFloat(q)) {
                    flashRow(row, parseFloat(prevOrderBook.bids[p]), parseFloat(q), 'green');
                }
                prevOrderBook.bids[p] = q;
            });
        }

        function renderTrades(trades) {
            if (!recentTradesDiv) return;
            recentTradesDiv.innerHTML = '';
            (trades || []).slice().reverse().forEach(t => {
                const d = document.createElement('div');
                const price = parseFloat(t.price).toFixed(4);
                const qty = parseFloat(t.qty).toFixed(4);
                const time = new Date(t.time || Date.now()).toLocaleTimeString();
                d.className = `flex justify-between items-center py-1 px-2 border-b border-gray-700 last:border-b-0 text-sm ${t.isBuyerMaker ? 'text-red-400' : 'text-green-400'}`;
                d.innerHTML = `
                <div class="mono">${price}</div>
                <div class="mono text-gray-400">${qty}</div>
                <div class="text-gray-500">${time}</div>
                `;
                recentTradesDiv.appendChild(d);
            });
        }

        /* ====== Flash Effects ===== */
        function flashElement(element, dir) {
            if (!element) return;
            element.classList.remove('flash-green', 'flash-red');
            void element.offsetWidth; // Trigger reflow
            if (dir === 'up') {
                element.classList.add('flash-green');
            } else if (dir === 'down') {
                element.classList.add('flash-red');
            }
        }

        function flashRow(div, prevQty, newQty, color) {
            div.style.transition = 'background .4s ease';
            if (prevQty === undefined || prevQty === newQty) return;
            if (newQty > prevQty) {
                div.style.background = (color === 'green' ? 'rgba(0,255,0,.18)' : 'rgba(255,0,0,.18)');
            } else {
                div.style.background = 'rgba(128,128,128,.18)';
            }
            setTimeout(() => div.style.background = 'transparent', 400);
        }

        /* ====== VWAP ====== */
        function updateVWAP(nowTs) {
            tradeWindow = tradeWindow.filter(t => t.time >= nowTs - 30_000);
            let vol = 0,
                pv = 0;
            for (const t of tradeWindow) {
                const q = parseFloat(t.qty) || 0;
                const p = parseFloat(t.price) || 0;
                vol += q;
                pv += p * q;
            }
            const vwap = vol > 0 ? pv / vol : null;
            // VWAP is not explicitly displayed on the new UI, but logic is kept for data integrity
        }

        /* ====== Lightweight Charts (for Trade Screen) ====== */

        function initializeAndRenderTradeChart() {
            const chartDiv = document.getElementById('tradeChartContainer');
            if (!chartDiv) {
                console.error("Trade chart container not found.");
                return;
            }

            // Only initialize if it doesn't exist and the container is visible/sized
            if (!lightweightChartInstance) {
                if (chartDiv.clientWidth === 0 || chartDiv.clientHeight === 0) {
                    console.log("Chart container is not visible or has zero size, deferring initialization.");
                    return;
                }
                try {
                    chartDiv.innerHTML = ''; // Clear any previous content
                    lightweightChartInstance = LightweightCharts.createChart(chartDiv, {
                        width: chartDiv.clientWidth,
                        height: 300,
                        rightPriceScale: {
                            borderColor: '#555',
                            textColor: body.classList.contains('dark') ? '#fff' : '#111'
                        },
                        timeScale: {
                            borderColor: '#555',
                            textColor: body.classList.contains('dark') ? '#fff' : '#111'
                        },
                        layout: {
                            backgroundColor: body.classList.contains('dark') ? '#1e1e1e' : '#ffffff',
                            textColor: body.classList.contains('dark') ? '#fff' : '#111'
                        },
                        grid: {
                            vertLines: { color: body.classList.contains('dark') ? '#333' : '#eee' },
                            horzLines: { color: body.classList.contains('dark') ? '#333' : '#eee' }
                        }
                    });
                    candleSeries = lightweightChartInstance.addCandlestickSeries({
                        upColor: '#22c55e',
                        downColor: '#ef4444',
                        borderVisible: false,
                        wickColor: body.classList.contains('dark') ? '#fff' : '#111',
                        wickUpColor: '#22c55e',
                        wickDownColor: '#ef4444'
                    });

                    new ResizeObserver(entries => {
                        if (entries.length === 0 || entries[0].contentRect.width === 0) return;
                        lightweightChartInstance.applyOptions({ width: entries[0].contentRect.width });
                    }).observe(chartDiv);
                    console.log("Lightweight Chart and Series initialized.");
                } catch (e) {
                    console.error("Error initializing Lightweight Charts:", e);
                    showMessageModal("Failed to initialize chart. Please try refreshing.");
                    // Reset to null if initialization failed, so it can be retried.
                    lightweightChartInstance = null;
                    candleSeries = null;
                    return; // Exit to prevent further errors
                }
            }
            // Now that chart is initialized (or exists), update it with data
            updateTradeScreen(selectedCoin);
        }

        function updateTradeScreen(coin) {
            if (!coin) {
                console.warn("No coin selected for trade screen update.");
                return;
            }

            selectedCoin = coin;

            // Ensure lightweightChartInstance and candleSeries exist before trying to update
            if (!lightweightChartInstance || !candleSeries) {
                console.warn("Chart or series not initialized. Cannot update trade screen data yet.");
                return;
            }

            // Update chart options for theme changes
            lightweightChartInstance.applyOptions({
                layout: {
                    backgroundColor: body.classList.contains('dark') ? '#1e1e1e' : '#ffffff',
                    textColor: body.classList.contains('dark') ? '#fff' : '#111'
                },
                grid: {
                    vertLines: { color: body.classList.contains('dark') ? '#333' : '#eee' },
                    horzLines: { color: body.classList.contains('dark') ? '#333' : '#eee' }
                },
                rightPriceScale: {
                    textColor: body.classList.contains('dark') ? '#fff' : '#111'
                },
                timeScale: {
                    textColor: body.classList.contains('dark') ? '#fff' : '#111'
                }
            });
            candleSeries.applyOptions({
                wickColor: body.classList.contains('dark') ? '#fff' : '#111'
            });

            if (tradePairDisplay) tradePairDisplay.textContent = `${selectedCoin.symbol.toUpperCase()}/USDT`;

            if (selectedCoin.sparkline_in_7d && selectedCoin.sparkline_in_7d.price.length > 0) {
                const ohlcData = selectedCoin.sparkline_in_7d.price.map((p, i) => {
                    const time = Date.now() / 1000 - (selectedCoin.sparkline_in_7d.price.length - 1 - i) * 3600;
                    const open = p * (1 - (Math.random() * 0.01));
                    const close = p * (1 + (Math.random() * 0.01));
                    const high = Math.max(open, close) * (1 + (Math.random() * 0.005));
                    const low = Math.min(open, close) * (1 - (Math.random() * 0.005));
                    return { time: time, open: open, high: high, low: low, close: close };
                });
                candleSeries.setData(ohlcData);
            } else {
                candleSeries.setData([]);
            }

            renderOrderBook(latestDepth);
            renderTrades(latestTrades);
        }

        function destroyTradeChart() {
            if (lightweightChartInstance) {
                console.log("Destroying Lightweight Chart.");
                lightweightChartInstance.remove();
                lightweightChartInstance = null;
                candleSeries = null;
            }
        }

        /* ====== CoinGecko Market Data (for Market Screen & Ticker) ====== */
        async function fetchMarketDataForUI(pageNum = 1, retries = 3, delay = 1000) {
            try {
                const apiUrl = `${CONFIG.COINGECKO_API_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${perPage}&page=${pageNum}&sparkline=true&price_change_percentage=24h`;
                const response = await fetch(apiUrl, {
                    headers: {
                        "Accept": "application/json",
                        "User-Agent": "MyCryptoDashboard/1.0"
                    }
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        console.warn(`CoinGecko API rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchMarketDataForUI(pageNum, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                return await response.json();
            } catch (e) {
                console.error("Error fetching CoinGecko data:", e);
                showMessageModal(`Failed to load market data: ${e.message || 'Unknown network error'}. Please check your internet connection or try again later.`);
                return [];
            }
        }

        async function loadMarket() {
            if (statusBox) {
                statusBox.innerHTML = '<p class="text-lg text-gray-400">Loading market data...</p>';
                statusBox.classList.remove("hidden");
            }
            if (marketBox) marketBox.classList.add("hidden");

            const newData = await fetchMarketDataForUI(page);

            if (page === 1) {
                cachedData = newData; // For initial load or full refresh
                if (!selectedCoin && cachedData.length > 0) {
                    selectedCoin = cachedData[0]; // Default to the top coin for trade screen
                }
            } else {
                cachedData = cachedData.concat(newData); // For "Load More"
            }

            if (cachedData.length === 0) {
                if (statusBox) {
                    statusBox.innerHTML =
                        `<div class="bg-red-800 text-white p-4 rounded-md text-center mb-4">
                            No market data available or failed to load. Please try again later.
                        </div>`;
                    statusBox.classList.remove("hidden");
                }
                if (loadMoreBtn) loadMoreBtn.classList.add('hidden');
                return;
            }

            // Update the main "Current Market" overview on the homepage
            if (cachedData.length > 0) {
                const mainCoin = cachedData[0]; // Typically BTC or top market cap coin
                const homePairLabel = document.getElementById('homePairLabel');
                const homePriceNow = document.getElementById('homePriceNow');
                const homePct = document.getElementById('homePct');

                if (homePairLabel) homePairLabel.textContent = `${mainCoin.symbol.toUpperCase()}/USDT`;
                if (homePriceNow) homePriceNow.textContent = parseFloat(mainCoin.current_price).toFixed(2);
                if (homePct) {
                    const pctChange = mainCoin.price_change_percentage_24h || 0;
                    homePct.textContent = `${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(2)}%`;
                    homePct.className = `small ${pctChange >= 0 ? 'text-green-500' : 'text-red-500'}`;
                }
            }

            renderMarket(cachedData); // Render the list of coins
            renderTicker(cachedData); // Update the ticker
            renderLandingMarket(cachedData.slice(0, 5)); // Render top 5 coins on landing page
            // Only update trade screen if it's currently active.
            if (tradeScreen && tradeScreen.classList.contains('active')) {
                updateTradeScreen(selectedCoin);
            }

            // Show data, hide status
            if (statusBox) statusBox.classList.add("hidden");
            if (marketBox) marketBox.classList.remove("hidden");
        }

        function renderMarket(data, targetElement = coinsList) {
            if (!targetElement) return;
            targetElement.innerHTML = ''; // Clear previous content

            data.forEach(coin => {
                const changeClass = coin.price_change_percentage_24h >= 0 ? "green-text" : "red-text";

                const coinRow = document.createElement("div");
                coinRow.className =
                    "grid grid-cols-2 sm:grid-cols-4 gap-4 py-3 px-4 border-b last:border-b-0 items-center transition-colors duration-200 rounded-md";

                // Apply theme-specific background and border colors for rows
                if (body.classList.contains('light')) {
                    coinRow.classList.add('border-gray-200');
                    coinRow.classList.remove('border-gray-800'); // Ensure dark theme border is removed
                } else {
                    coinRow.classList.add('border-gray-800');
                    coinRow.classList.remove('border-gray-200'); // Ensure light theme border is removed
                }

                coinRow.innerHTML = `
                    <!-- Coin Name & Symbol -->
                    <div class="flex items-center col-span-2 sm:col-span-1 cursor-pointer" data-coin-id="${coin.id}">
                        <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 mr-3 rounded-full"
                            onerror="this.onerror=null;this.src='https://placehold.co/40x40/333333/FFFFFF?text=?'"/>
                        <div>
                            <p class="font-semibold text-lg">${coin.name}</p>
                            <p class="text-gray-400 text-sm uppercase">${coin.symbol}</p>
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="text-right">
                        <p class="font-semibold text-lg">$${coin.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })}</p>
                    </div>

                    <!-- 24h Change -->
                    <div class="text-right ${changeClass}">
                        <p class="font-semibold text-lg">${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(2) : '0.00'}%</p>
                    </div>

                    <!-- Market Cap -->
                    <div class="hidden sm:block text-right text-gray-300">
                        <p class="text-md">Mkt Cap: $${coin.market_cap ? coin.market_cap.toLocaleString() : 'N/A'}</p>
                    </div>
                `;

                targetElement.appendChild(coinRow);

                // Add click listener to the entire coin row for navigation to trade screen
                coinRow.querySelector('[data-coin-id]').addEventListener('click', () => {
                    selectedCoin = data.find(c => c.id === coin.id);
                    if (selectedCoin) {
                        currentPair = `${selectedCoin.symbol.toUpperCase()}USDT`;
                        navigateToPage('trade');
                    }
                });
            });
            if (loadMoreBtn && targetElement === coinsList) loadMoreBtn.classList.toggle('hidden', data.length < perPage);
        }

        function renderLandingMarket(data) {
            if (!landingMarketList) return;
            landingMarketList.innerHTML = ''; // Clear previous content

            data.forEach(coin => {
                const changeClass = coin.price_change_percentage_24h >= 0 ? "green-text" : "red-text";

                const coinRow = document.createElement("div");
                coinRow.className = "coin-row"; // Use the custom class from style block for landing page
                coinRow.dataset.coinId = coin.id; // For event listener

                coinRow.innerHTML = `
                    <div class="coin-info">
                        <img src="${coin.image}" alt="${coin.name}" onerror="this.onerror=null;this.src='https://placehold.co/28x28/333333/FFFFFF?text=?'"/>
                        <div>
                            <div class="coin-name">${coin.name}</div>
                            <div class="coin-symbol">${coin.symbol}</div>
                        </div>
                    </div>
                    <div class="price">$${coin.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })}</div>
                    <div class="change ${changeClass}">${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(2) : '0.00'}%</div>
                `;
                landingMarketList.appendChild(coinRow);

                coinRow.addEventListener('click', () => {
                    selectedCoin = cachedData.find(c => c.id === coin.id);
                    if (selectedCoin) {
                        currentPair = `${selectedCoin.symbol.toUpperCase()}USDT`;
                        navigateToPage('trade');
                    }
                });
            });
        }

        function renderTicker(data) {
            if (!ticker) return;
            ticker.innerHTML = '';
            // Only use the first 10 for the ticker
            data.slice(0, 10).forEach(c => {
                const span = document.createElement('span');
                const priceChangeColor = c.price_change_percentage_24h > 0 ? 'text-green-400' : 'text-red-400';
                span.innerHTML = `<img src="${c.image}" onerror="this.onerror=null;this.src='https://placehold.co/18x18/121212/e6eef8?text=?'">${c.symbol.toUpperCase()} <span class="font-mono">$${c.current_price.toFixed(4)}</span> <span class="${priceChangeColor}">${c.price_change_percentage_24h > 0 ? '+' : ''}${c.price_change_percentage_24h ? c.price_change_percentage_24h.toFixed(2) : '0.00'}%</span>`;
                ticker.appendChild(span);
            });
            let offset = 0;
            const tickerScrollSpeed = 0.5;
            if (ticker.scrollInterval) {
                clearInterval(ticker.scrollInterval);
            }
            ticker.scrollInterval = setInterval(() => {
                offset -= tickerScrollSpeed;
                ticker.style.transform = `translateX(${offset}px)`;
                if (Math.abs(offset) > ticker.scrollWidth / 2) {
                    offset = 0;
                }
            }, 20);
        }

        async function updatePricesAndMarket() {
            try {
                const data = await fetchMarketDataForUI(page);
                cachedData = data; // Update cached data for search and re-rendering
                renderMarket(data); // Re-render market list to update prices and flashes
                renderTicker(data); // Re-render ticker for updated prices
                renderLandingMarket(data.slice(0,5)); // Update landing page market list
                // Only update trade screen if it's currently active.
                if (tradeScreen && tradeScreen.classList.contains('active')) {
                    // Find the updated data for the currently selected coin
                    const updatedSelectedCoin = data.find(c => c.id === selectedCoin?.id); // Use optional chaining
                    if (updatedSelectedCoin) {
                        selectedCoin = updatedSelectedCoin; // Update the selectedCoin object
                        updateTradeScreen(selectedCoin); // Update trade screen chart and data
                    } else if (selectedCoin) { // If selectedCoin exists but not found in new data, just update the chart without new data
                        updateTradeScreen(selectedCoin);
                    }
                }
            } catch (error) {
                console.error("Error updating prices and market:", error);
                // The fetchMarketDataForUI already shows a modal, so no need to show another here.
            }
        }

        function setPair(pair) {
            if (pair === currentPair) return;
            currentPair = pair;
            lastPrice = null; // Reset last price for percentage change calculation
            priceHistory = []; // Clear sparkline history
            tradeWindow = []; // Clear VWAP history
            wsFailures = 0; // Reset WS failure count
            stopAll(); // Stop existing WebSocket/HTTP connections
            startWS(currentPair); // Start new WebSockets for the new pair
        }

        function startWS(pair) {
            stopAll(); // Ensure all previous connections are closed

            const sym = pair.toLowerCase();
            depthSocket = new WebSocket(`${BINANCE_WS_BASE}${sym}@depth@100ms`);
            tradeSocket = new WebSocket(`${BINANCE_WS_BASE}${sym}@aggTrade`);

            depthSocket.onmessage = ev => {
                try {
                    const d = JSON.parse(ev.data);
                    latestDepth = { bids: d.b || [], asks: d.a || [] };
                    renderOrderBook(latestDepth);
                } catch (e) { console.error("WS Depth parse error:", e); }
            };

            tradeSocket.onmessage = ev => {
                try {
                    const t = JSON.parse(ev.data);
                    const trade = { price: t.p, qty: t.q, time: t.T, isBuyerMaker: t.m };
                    latestTrades.push(trade);
                    if (latestTrades.length > 30) latestTrades = latestTrades.slice(-30);
                    tradeWindow.push(trade);
                    renderTrades(latestTrades);

                    const p = parseFloat(trade.price);
                    if (tradePriceDisplay) {
                        flashElement(tradePriceDisplay, p > lastPrice ? 'up' : 'down');
                        tradePriceDisplay.textContent = p.toFixed(4);
                    }
                    lastPrice = p;

                    if (priceHistory.length === 0 && p !== null) {
                        priceHistory.push(p);
                    }
                    priceHistory.push(p);
                    if (priceHistory.length > 200) priceHistory = priceHistory.slice(-200);

                    updateVWAP(trade.time);
                } catch (e) { console.error("WS Trade parse error:", e); }
            };

            const wsErrorHandler = (socketName) => (event) => {
                console.error(`WebSocket ${socketName} error:`, event);
                wsFailures += 1;
                showMessageModal(`WebSocket ${socketName} error. Reconnecting...`);
            };

            const wsCloseHandler = (socketName) => (event) => {
                console.warn(`WebSocket ${socketName} closed: ${event.code} - ${event.reason}. Retrying...`);
                if (tradeScreen && tradeScreen.classList.contains('active')) {
                    const delay = Math.min(wsBackoff * Math.pow(2, wsFailures - 1), wsBackoffMax);
                    setTimeout(() => startWS(pair), delay);
                }
            };

            depthSocket.onerror = wsErrorHandler('Depth');
            tradeSocket.onerror = wsErrorHandler('Trade');
            depthSocket.onclose = wsCloseHandler('Depth');
            tradeSocket.onclose = wsCloseHandler('Trade');
        }

        let httpFailures = 0;
        let httpBackoff = 1000;

        async function startHttpPolling(pair) {
            stopAll();
            // httpIntervalMs is no longer controlled by a select, use default or a global constant
            httpIntervalMs = 3000;
            const fetchData = async () => {
                try {
                    const [tickerResponse, orderBookResponse, tradesResponse] = await Promise.all([
                        fetch(`${BINANCE_REST_BASE}ticker/24hr?symbol=${pair}`),
                        fetch(`${BINANCE_REST_BASE}depth?symbol=${pair}&limit=20`),
                        fetch(`${BINANCE_REST_BASE}trades?symbol=${pair}&limit=30`)
                    ]);

                    if (!tickerResponse.ok || !orderBookResponse.ok || !tradesResponse.ok) {
                        throw new Error('Failed to fetch data from Binance REST API');
                    }

                    const tickerData = await tickerResponse.json();
                    const obData = await orderBookResponse.json();
                    const tradesData = await tradesResponse.json();

                    const p = parseFloat(tickerData.lastPrice);
                    if (tradePriceDisplay) {
                        flashElement(tradePriceDisplay, p > lastPrice ? 'up' : 'down');
                        tradePriceDisplay.textContent = p.toFixed(4);
                    }
                    lastPrice = p;

                    priceHistory.push(p);
                    if (priceHistory.length > 200) priceHistory = priceHistory.slice(-200);

                    latestDepth = { bids: obData.bids || [], asks: obData.asks || [] };
                    renderOrderBook(latestDepth);

                    latestTrades = tradesData.map(t => ({ price: t.price, qty: t.qty, time: t.time || Date.now(), isBuyerMaker: t.isBuyerMaker || false })).slice(-30);
                    renderTrades(latestTrades);

                    tradeWindow = latestTrades.map(t => ({ price: t.price, quantity: t.qty, timestamp: t.time }));
                    updateVWAP(Date.now());

                    httpFailures = 0;
                    showMessageModal(`HTTP polling for ${pair} updated.`);

                } catch (e) {
                    console.error("HTTP polling error:", e);
                    httpFailures += 1;
                    const delay = Math.min(httpBackoff * Math.pow(2, httpFailures - 1), wsBackoffMax);
                    showMessageModal(`HTTP polling error. Retrying in ${delay / 1000}s...`);
                    if (httpTimer) clearInterval(httpTimer);
                    httpTimer = setTimeout(() => startHttpPolling(pair), delay);
                    return;
                }
                if (httpTimer) clearInterval(httpTimer);
                httpTimer = setTimeout(fetchData, httpIntervalMs);
            };
            fetchData();
        }

        function stopAll() {
            if (depthSocket) {
                depthSocket.onclose = null; // Prevent unwanted re-connection on manual close
                depthSocket.onerror = null;
                try { depthSocket.close(); } catch (e) { console.error("Error closing depth socket:", e); }
                depthSocket = null;
            }
            if (tradeSocket) {
                tradeSocket.onclose = null; // Prevent unwanted re-connection on manual close
                tradeSocket.onerror = null;
                try { tradeSocket.close(); } catch (e) { console.error("Error closing trade socket:", e); }
                tradeSocket = null;
            }
            if (httpTimer) {
                clearTimeout(httpTimer);
                httpTimer = null;
            }
            wsFailures = 0; // Reset WebSocket failure count on full stop
            httpFailures = 0; // Reset HTTP failure count on full stop
        }

        /* ====== Wallet/Deposit Functions ====== */
        function generateMockAddress(network) {
            if (network === 'SOL') return 'GwobMFEUFxPH3kfpHjbyCsKcVaPV4ptAePEPdnpHdmn5';
            if (network === 'BTC') return 'bc1q9ldrkd44xk9xlg3qgefx5avhl7hwlfaqaktsmx';
            let address = '0x';
            for (let i = 0; i < 40; i++) {
                address += Math.floor(Math.random() * 16).toString(16);
            }
            return address;
        }

        function updateDepositUI(network) {
            currentDepositNetwork = network;
            const address = DEPOSIT[network] || generateMockAddress(network);
            const chainInfo = networks.find(n => n.id === network.toLowerCase() || n.symbol === network);
            const explorerUrl = chainInfo ? `${chainInfo.explorerUrl}${address}` : '#';

            if (depositLabel) depositLabel.textContent = `${network} (${network === 'ETH' ? 'ERC20' : (network === 'BSC' ? 'BEP20' : 'Native')})`;
            if (depositAddr) depositAddr.textContent = address;
            if (explorerDepositBtn) explorerDepositBtn.href = explorerUrl;

            if (depositQR) {
                depositQR.innerHTML = '';
                new QRCode(depositQR, {
                    text: address,
                    width: 140,
                    height: 140,
                    colorDark: body.classList.contains('dark') ? "#FCD535" : "#000000",
                    colorLight: body.classList.contains('dark') ? "#071827" : "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            if (depositBtns) {
                depositBtns.forEach(btn => {
                    if (btn.dataset.net === network) {
                        btn.classList.add('accent');
                    } else {
                        btn.classList.remove('accent');
                    }
                });
            }
        }

        /* ====== Smartsupp chat loader (only on Chat page) ====== */
        function loadSmartsuppChat() {
            if (document.getElementById('smartsupp-script')) return;
            const script = document.createElement('script'); script.id = 'smartsupp-script'; script.type = 'text/javascript'; script.async = true; script.charset = 'utf-8'; script.src = 'https://www.smartsuppchat.com/loader.js?'; document.head.appendChild(script);
            window._smartsupp = { key: '3ab3e4c3fcd21f84344cc872db2a35d9e40245a6' };
            showMessageModal('Smartsupp chat loaded!');
        }
        function unloadSmartsuppChat() {
            const s = document.getElementById('smartsupp-script');
            if (s) {
                s.remove();
                window.smartsupp = undefined;
                window._smartsupp = undefined;
                showMessageModal('Smartsupp chat unloaded.');
            }
        }

        /* ====== PWA Install Prompt ====== */
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install prompt button if PWA can be installed
            if (landingPWAInstallBtn) {
                landingPWAInstallBtn.style.display = 'block';
            }
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                if (outcome === 'accepted') {
                    showMessageModal('On-Chain app installed!');
                    if (landingPWAInstallBtn) landingPWAInstallBtn.style.display = 'none'; // Hide install button after successful install
                } else {
                    showMessageModal('App installation dismissed.');
                }
            } else {
                showMessageModal('App is already installed or cannot be installed.');
            }
        }

        window.addEventListener('appinstalled', () => {
            if (landingPWAInstallBtn) landingPWAInstallBtn.style.display = 'none';
            showMessageModal('On-Chain app successfully installed!');
            console.log('PWA was installed');
        });

        /* ====== Wallet Connector Logic ====== */
        function showConnectSection(sectionId) {
            const sections = {
                'mobile': mobileConnectSection,
                'browser': browserConnectSection,
                'manual': manualConnectSection
            };
            const buttons = {
                'mobile': showMobileConnectBtn,
                'browser': showBrowserConnectBtn,
                'manual': showManualConnectBtn
            };

            for (const key in sections) {
                if (sections[key]) {
                    if (key === sectionId) {
                        sections[key].classList.remove('hidden');
                        buttons[key].classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        buttons[key].classList.add('bg-blue-600', 'hover:bg-blue-700');
                    } else {
                        sections[key].classList.add('hidden');
                        buttons[key].classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        buttons[key].classList.add('bg-gray-700', 'hover:bg-gray-600');
                    }
                }
            }

            // Reset UI for other sections when switching
            if (sectionId !== 'mobile') resetMobileConnectUI();
            if (sectionId !== 'browser') resetBrowserConnectUI();
            if (sectionId !== 'manual') resetManualConnectUI();

            // Special case to ensure manual connect button is correct on initial load of manual section
            if (sectionId === 'manual') {
                 if (networkSelect.value && walletAddressInput.value.trim()) {
                    fetchBalanceButton.classList.remove('hidden');
                 } else {
                    fetchBalanceButton.classList.add('hidden');
                 }
                 manualConnectNote.classList.remove('hidden');
            }
        }

        async function updateMobileNetworkInfo(chainId) {
            const connectedChainIdNum = parseInt(chainId, 16);
            const network = networks.find(n => n.type === 'evm' && parseInt(n.chainId, 16) === connectedChainIdNum);
            if (mobileWalletNetworkSpan) mobileWalletNetworkSpan.textContent = network ? network.name : 'Unknown Network';
            if (mobileWalletChainIdSpan) mobileWalletChainIdSpan.textContent = connectedChainIdNum;
            connectedChainId = connectedChainIdNum;
        }

        async function connectMobileWallet() {
            if (mobileLoadingSpinner) mobileLoadingSpinner.classList.remove('hidden');
            if (connectMobileButton) connectMobileButton.disabled = true;
            if (mobileConnectStatus) mobileConnectStatus.textContent = 'Opening WalletConnect modal...';

            try {
                if (typeof WalletConnectProvider === 'undefined' || !WalletConnectProvider.default) {
                    showMessageModal("WalletConnect library not loaded. Please check your internet connection.");
                    return;
                }

                wcProviderInstance = new WalletConnectProvider.default({
                    projectId: CONFIG.SIGN_PROJECT_ID,
                    infuraId: CONFIG.INFURA_ID,
                    qrcode: true,
                    pollingInterval: 15000,
                    rpc: Object.fromEntries(networks.filter(n => n.type === 'evm' && n.rpc).map(n => [parseInt(n.chainId, 16), n.rpc]))
                });

                wcProviderInstance.on("accountsChanged", (accounts) => {
                    console.log("Mobile accounts changed:", accounts);
                    if (accounts.length > 0) {
                        connectedAccount = accounts[0];
                        if (mobileWalletAddressSpan) mobileWalletAddressSpan.textContent = connectedAccount;
                        updateConnectButtonText();
                        showMessageModal(`Mobile wallet account changed to: ${connectedAccount}`);
                    } else {
                        disconnectMobileWallet();
                    }
                });

                wcProviderInstance.on("chainChanged", (chainId) => {
                    console.log("Mobile chain changed:", chainId);
                    updateMobileNetworkInfo(chainId);
                    updateConnectButtonText();
                    showMessageModal(`Mobile wallet network changed to Chain ID: ${parseInt(chainId, 16)}`);
                });

                wcProviderInstance.on("disconnect", (code, reason) => {
                    console.log("Mobile WalletConnect Disconnected:", code, reason);
                    disconnectMobileWallet();
                    showMessageModal(`Mobile wallet disconnected. Reason: ${reason || 'Unknown'}`);
                });

                await wcProviderInstance.enable();
                web3 = new Web3(wcProviderInstance);
                const accounts = await web3.eth.getAccounts();
                const chainId = await web3.eth.getChainId();

                if (accounts.length > 0) {
                    connectedAccount = accounts[0];
                    connectedChainId = Number(chainId);
                    if (mobileConnectStatus) mobileConnectStatus.textContent = `Wallet Connected!`;
                    if (mobileWalletAddressSpan) mobileWalletAddressSpan.textContent = connectedAccount;
                    if (mobileConnectedInfo) mobileConnectedInfo.classList.remove('hidden');
                    if (connectMobileButton) connectMobileButton.classList.add('hidden');
                    if (disconnectMobileButton) disconnectMobileButton.classList.remove('hidden');
                    updateMobileNetworkInfo('0x' + connectedChainId.toString(16));
                    updateConnectButtonText();
                    showMessageModal(`Successfully connected mobile wallet: ${connectedAccount}`);
                    showTerminal(); // Transition to terminal after successful connection
                } else {
                    showMessageModal("No accounts found from mobile wallet. Please try connecting again.");
                    resetMobileConnectUI();
                }

            } catch (error) {
                console.error("Mobile wallet connection failed:", error);
                let errorMessage = "An unknown error occurred during mobile wallet connection.";
                if (error.message && error.message.includes("User closed modal")) {
                    errorMessage = "WalletConnect modal was closed. Please try again to connect.";
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (error.code) {
                    errorMessage = `Error Code: ${error.code}`;
                }
                showMessageModal(`Connection Error: ${errorMessage}`);
                resetMobileConnectUI();
            } finally {
                if (mobileLoadingSpinner) mobileLoadingSpinner.classList.add('hidden');
                if (connectMobileButton) connectMobileButton.disabled = false;
            }
        }

        async function disconnectMobileWallet() {
            if (wcProviderInstance && wcProviderInstance.connected) {
                try {
                    await wcProviderInstance.disconnect();
                } catch (error) {
                    console.error("Error during WalletConnect disconnect:", error);
                }
            }
            web3 = null;
            connectedAccount = null;
            connectedChainId = null;
            wcProviderInstance = null;
            resetMobileConnectUI();
            updateConnectButtonText();
            showMessageModal('Mobile wallet disconnected successfully.');
            hideTerminal(); // Go back to landing page
        }

        function resetMobileConnectUI() {
            if (mobileConnectStatus) mobileConnectStatus.textContent = 'Connect your mobile wallet via WalletConnect.';
            if (mobileWalletAddressSpan) mobileWalletAddressSpan.textContent = '';
            if (mobileWalletNetworkSpan) mobileWalletNetworkSpan.textContent = '';
            if (mobileWalletChainIdSpan) mobileWalletChainIdSpan.textContent = '';
            if (mobileConnectedInfo) mobileConnectedInfo.classList.add('hidden');
            if (connectMobileButton) connectMobileButton.classList.remove('hidden');
            if (disconnectMobileButton) disconnectMobileButton.classList.add('hidden');
        }

        async function updateBrowserNetworkInfo(chainId) {
            const connectedChainIdNum = parseInt(chainId, 16);
            const network = networks.find(n => n.type === 'evm' && parseInt(n.chainId, 16) === connectedChainIdNum);
            if (browserWalletNetworkSpan) browserWalletNetworkSpan.textContent = network ? network.name : 'Unknown Network';
            if (browserWalletChainIdSpan) browserWalletChainIdSpan.textContent = connectedChainIdNum;
            connectedChainId = connectedChainIdNum;
        }

        async function connectBrowserWallet() {
            if (typeof window.ethereum === 'undefined') {
                showMessageModal("MetaMask or other Ethereum browser wallet not detected. Please install one.");
                return;
            }

            if (browserLoadingSpinner) browserLoadingSpinner.classList.remove('hidden');
            if (connectBrowserButton) connectBrowserButton.disabled = true;
            if (browserConnectStatus) browserConnectStatus.textContent = 'Requesting connection...';

            try {
                web3 = new Web3(window.ethereum);

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });

                if (accounts.length > 0) {
                    connectedAccount = accounts[0];
                    connectedChainId = Number(chainId);
                    if (browserConnectStatus) browserConnectStatus.textContent = 'Wallet Connected!';
                    if (browserWalletAddressSpan) browserWalletAddressSpan.textContent = connectedAccount;
                    if (browserConnectedInfo) browserConnectedInfo.classList.remove('hidden');
                    if (connectBrowserButton) connectBrowserButton.classList.add('hidden');
                    if (disconnectBrowserButton) disconnectBrowserButton.classList.remove('hidden');
                    updateBrowserNetworkInfo(chainId);
                    updateConnectButtonText();

                    showMessageModal(`Successfully connected browser wallet: ${connectedAccount}`);
                    showTerminal(); // Transition to terminal after successful connection

                    if (window.ethereum.removeListener) {
                        window.ethereum.removeListener('accountsChanged', handleBrowserAccountsChanged);
                        window.ethereum.removeListener('chainChanged', handleBrowserChainChanged);
                    }
                    window.ethereum.on('accountsChanged', handleBrowserAccountsChanged);
                    window.ethereum.on('chainChanged', handleBrowserChainChanged);

                } else {
                    showMessageModal("No accounts found. Please try connecting again.");
                    resetBrowserConnectUI();
                }
            } catch (error) {
                console.error("Browser wallet connection failed:", error);
                let errorMessage = "Connection failed. Please ensure your wallet is unlocked and try again.";
                if (error.code === 4001) {
                    errorMessage = "Connection rejected by user.";
                } else if (error.message) {
                    errorMessage = error.message;
                }
                showMessageModal(`Connection Error: ${errorMessage}`);
                resetBrowserConnectUI();
            } finally {
                if (browserLoadingSpinner) browserLoadingSpinner.classList.add('hidden');
                if (connectBrowserButton) connectBrowserButton.disabled = false;
            }
        }

        async function disconnectBrowserWallet() {
            showMessageModal("You have disconnected from the dApp. To fully disconnect, please do so from your browser wallet extension.");
            web3 = null;
            connectedAccount = null;
            connectedChainId = null;
            resetBrowserConnectUI();
            updateConnectButtonText();
            hideTerminal(); // Go back to landing page
        }

        function resetBrowserConnectUI() {
            if (browserConnectStatus) browserConnectStatus.textContent = 'Connect your browser-based wallet (e.g., MetaMask).';
            if (browserWalletAddressSpan) browserWalletAddressSpan.textContent = '';
            if (browserWalletNetworkSpan) browserWalletNetworkSpan.textContent = '';
            if (browserWalletChainIdSpan) browserWalletChainIdSpan.textContent = '';
            if (browserConnectedInfo) browserConnectedInfo.classList.add('hidden');
            if (connectBrowserButton) connectBrowserButton.classList.remove('hidden');
            if (disconnectBrowserButton) disconnectBrowserButton.classList.add('hidden');
            if (window.ethereum && window.ethereum.removeListener) {
                window.ethereum.removeListener('accountsChanged', handleBrowserAccountsChanged);
                window.ethereum.removeListener('chainChanged', handleBrowserChainChanged);
            }
        }

        function handleBrowserAccountsChanged(accounts) {
            console.log("Browser wallet accounts changed:", accounts);
            if (accounts.length > 0) {
                connectedAccount = accounts[0];
                if (browserWalletAddressSpan) browserWalletAddressSpan.textContent = connectedAccount;
                updateConnectButtonText();
                showMessageModal(`Browser wallet account changed to: ${connectedAccount}`);
            } else {
                showMessageModal("Browser wallet disconnected from dApp.");
                disconnectBrowserWallet();
            }
        }

        function handleBrowserChainChanged(chainId) {
            console.log("Browser wallet chain changed:", chainId);
            updateBrowserNetworkInfo(chainId);
            updateConnectButtonText();
            showMessageModal(`Browser wallet network changed to Chain ID: ${parseInt(chainId, 16)}`);
        }

        // Helper for exponential backoff retry logic
        async function retryOperation(operation, maxRetries = 3, initialDelay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed: ${error.message}`);
                    if (i < maxRetries - 1) {
                        const delay = initialDelay * Math.pow(2, i);
                        console.log(`Retrying in ${delay / 1000} seconds...`);
                        await sleep(delay);
                    } else {
                        throw error; // Re-throw after all retries exhausted
                    }
                }
            }
        }

        async function fetchBalance(networkId, address) {
            if (manualLoadingSpinner) {
                manualLoadingSpinner.classList.remove('hidden');
                manualLoadingSpinner.querySelector('p').textContent = 'Connecting...';
            }
            if (fetchBalanceButton) fetchBalanceButton.disabled = true;
            if (manualConnectionInfo) manualConnectionInfo.classList.add('hidden');
            if (viewWalletButton) viewWalletButton.classList.add('hidden');

            const network = networks.find(n => n.id === networkId);
            if (!network) {
                showMessageModal('Invalid network selected.');
                if (manualLoadingSpinner) manualLoadingSpinner.classList.add('hidden');
                if (fetchBalanceButton) fetchBalanceButton.disabled = false;
                return;
            }

            if (manualNetworkDisplay) manualNetworkDisplay.textContent = network.name;
            if (manualAddressDisplay) manualAddressDisplay.textContent = address;

            let balance = 'N/A';
            try {
                await sleep(1000); // Initial delay for UI update
                if (manualLoadingSpinner) manualLoadingSpinner.querySelector('p').textContent = 'Fetching balance...';

                if (network.type === 'evm') {
                    if (!network.rpc) {
                         showMessageModal(`RPC Not Configured for this EVM network.`);
                         balance = 'RPC Not Configured';
                    } else {
                        const web3Instance = new Web3(new Web3.providers.HttpProvider(network.rpc));
                        if (!web3Instance.utils.isAddress(address)) {
                            throw new Error("Invalid Ethereum address format.");
                        }
                        // Use retryOperation for EVM balance fetching
                        const weiBalance = await retryOperation(async () => {
                            return await web3Instance.eth.getBalance(address);
                        });
                        balance = web3Instance.utils.fromWei(weiBalance, 'ether') + ` ${network.symbol}`;
                    }
                } else {
                    switch (network.id) {
                        case 'btc':
                            const btcResponse = await fetch(`${network.api}${address}/balance`);
                            if (!btcResponse.ok) throw new Error(`BTC API error: ${btcResponse.statusText}`);
                            const btcData = await btcResponse.json();
                            balance = (btcData.balance / 10**8).toFixed(8) + ' BTC';
                            break;
                        case 'tron':
                            const tronResponse = await fetch(`${network.api}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ account: address })
                            });
                            if (!tronResponse.ok) throw new Error(`TRON API error: ${tronResponse.statusText}`);
                            const tronData = await tronResponse.json();
                            if (tronData && tronData.data && tronData.data.length > 0) {
                                balance = (tronData.data[0].balance / 10**6).toFixed(6) + ' TRX';
                            } else {
                                balance = '0 TRX';
                            }
                            break;
                        case 'solana':
                            const solResponse = await fetch(network.rpc, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    id: 1,
                                    method: 'getBalance',
                                    params: [address]
                                })
                            });
                            if (!solResponse.ok) throw new Error(`SOL API error: ${solResponse.statusText}`);
                            const solData = await solResponse.json();
                            if (solData.result && solData.result.value !== undefined) {
                                balance = (solData.result.value / 10**9).toFixed(9) + ' SOL';
                            } else {
                                balance = '0 SOL';
                            }
                            break;
                        case 'polkadot':
                        case 'cardano':
                            balance = 'Balance fetching for this network not yet integrated via API.';
                            break;
                        default:
                            balance = 'Balance fetching for this network requires specific APIs/SDKs or is not implemented.';
                            break;
                    }
                }

                if (balance !== 'Error' && balance !== 'N/A' && !balance.includes('RPC Not Configured') && !balance.includes('not yet integrated') && !balance.includes('not implemented')) {
                    showMessageModal(`Successfully fetched balance for: ${address} on ${network.name}. Balance: ${balance}`);
                    if (network.explorerUrl && viewWalletButton) {
                        viewWalletButton.onclick = () => window.open(`${network.explorerUrl}${address}`, '_blank');
                        viewWalletButton.classList.remove('hidden');
                    }
                    connectedAccount = address; // Set for UI purposes
                    connectedChainId = network.id; // Store network ID
                    showTerminal(); // Transition to terminal after successful connection
                }

            } catch (error) {
                console.error(`Error connecting to wallet and fetching balance for ${network.name}:`, error);
                let displayMessage = `Error fetching balance for ${network.name}. ${error.message || error}.`;

                if (error.message && error.message.includes("Invalid JSON RPC response")) {
                    displayMessage = `Failed to fetch balance for ${network.name}. This might be a temporary issue with the network provider or your internet connection. Please try again.`;
                } else if (error.message && error.message.includes("Node error: Invalid address")) {
                    displayMessage = `Invalid address format for ${network.name}. Please check the address.`;
                }
                showMessageModal(displayMessage);
                balance = 'Error';
            } finally {
                if (manualBalanceDisplay) manualBalanceDisplay.textContent = balance;
                if (manualConnectionInfo) manualConnectionInfo.classList.remove('hidden');
                if (manualLoadingSpinner) manualLoadingSpinner.classList.add('hidden');
                if (fetchBalanceButton) fetchBalanceButton.disabled = false;
            }
        }

        function resetManualConnectUI() {
            if (networkSelect) networkSelect.value = '';
            if (walletAddressInput) walletAddressInput.value = '';
            if (addressInputContainer) addressInputContainer.classList.add('hidden');
            if (fetchBalanceButton) fetchBalanceButton.classList.add('hidden');
            if (manualConnectionInfo) manualConnectionInfo.classList.add('hidden');
            if (viewWalletButton) viewWalletButton.classList.add('hidden');
            if (manualConnectNote) manualConnectNote.classList.add('hidden');
            if (manualLoadingSpinner) manualLoadingSpinner.classList.add('hidden');
        }

        function updateConnectButtonText() {
            if (btnConnect) {
                if (connectedAccount) {
                    btnConnect.textContent = `${connectedAccount.slice(0, 6)}...${connectedAccount.slice(-4)}`;
                } else {
                    btnConnect.textContent = 'Connect';
                }
            }
        }

        // Mock functions for `doApprove`, `estimateGas`, and `sendUSDT`
        async function doApprove(isMax) {
            if (!web3 || !connectedAccount) {
                showMessageModal('Please connect your wallet first.');
                return;
            }
            showMessageModal(`Approving ${isMax ? 'max' : 'standard'} amount (mock)...`);
            await sleep(1500); // Simulate network delay
            showMessageModal(`Mock Approval successful for ${isMax ? 'max' : 'standard'} amount.`);
        }

        async function estimateGas() {
            if (!web3 || !connectedAccount) {
                showMessageModal('Please connect your wallet first.');
                return;
            }
            if (!recipient?.value || !amount?.value) {
                showMessageModal('Please enter recipient and amount for gas estimation.');
                return;
            }
            showMessageModal('Estimating gas (mock)...');
            await sleep(1000); // Simulate network delay
            const mockGasPrice = 20; // Gwei
            const mockGasLimit = 50000; // units
            // Ensure web3 is defined before using its utility functions
            const feeUSD = web3 ? (mockGasPrice * mockGasLimit * parseFloat(web3.utils.fromWei('1', 'gwei')) * 3000).toFixed(2) : 'N/A'; // Example conversion to USD
            if (feeBox) feeBox.textContent = `Estimated Fee: ${mockGasLimit} units ($${feeUSD} USD)`;
        }

        async function sendUSDT() {
            if (!web3 || !connectedAccount) {
                showMessageModal('Please connect your wallet first.');
                return;
            }
            const targetChain = sendChain?.value;
            const recipientAddress = recipient?.value;
            const sendAmount = amount?.value;

            if (!targetChain || !recipientAddress || !sendAmount || parseFloat(sendAmount) <= 0) {
                showMessageModal('Please fill all required fields: Chain, Recipient, and Amount.');
                return;
            }

            // Ensure web3 is defined before using its utility functions
            if (web3 && !web3.utils.isAddress(recipientAddress)) {
                showMessageModal('Invalid recipient address.');
                return;
            }

            const usdtContractAddress = USDT_CONTRACTS[targetChain];
            if (!usdtContractAddress) {
                showMessageModal(`USDT contract not defined for ${targetChain}.`);
                return;
            }

            showMessageModal(`Sending ${sendAmount} USDT on ${targetChain} to ${recipientAddress} (mock)...`);

            await sleep(2000); // Simulate network delay
            if (sendMsg) sendMsg.textContent = `Mock Transfer successful! Sent ${sendAmount} USDT.`;
            showMessageModal(`Mock Transfer successful! Sent ${sendAmount} USDT.`);
        }

        async function runSim() {
            const pair = document.getElementById('simPair')?.value || 'BTCUSDT';
            const type = document.getElementById('simType')?.value || 'buyhold';
            const days = parseInt(document.getElementById('simDays')?.value || '30') || 30;
            if (simResult) simResult.textContent = 'Running simulation with mock data...';
            await new Promise(resolve => setTimeout(resolve, 800));

            try {
                const mockPrices = [];
                let startPrice = 100;
                for (let i = 0; i < days; i++) {
                    mockPrices.push(startPrice + (Math.random() - 0.5) * 5);
                }
                const prices = mockPrices;

                if (!prices.length) { if (simResult) simResult.textContent = 'No data to simulate.'; return; }
                let cash = 1000, pos = 0, trades = [];
                if (type === 'buyhold') { pos = cash / prices[0]; cash = 0; trades.push({ type: 'buy', price: prices[0] }); }
                else if (type === 'ma') {
                    const fast = 5, slow = 20; for (let i = slow; i < prices.length; i++) { const fastMA = avg(prices.slice(i - fast + 1, i + 1)); const slowMA = avg(prices.slice(i - slow + 1, i + 1)); const fastPrev = avg(prices.slice(i - fast, i)); const slowPrev = avg(prices.slice(i - slow, i)); if (fastPrev <= slowPrev && fastMA > slowMA && cash > 0) { pos = cash / prices[i]; cash = 0; trades.push({ type: 'buy', price: prices[i] }); } if (fastPrev >= slowPrev && fastMA < slowMA && pos > 0) { cash = pos * prices[i]; pos = 0; trades.push({ type: 'sell', price: prices[i] }); } }
                } else if (type === 'rsi') {
                    const w = 14; for (let i = w; i < prices.length; i++) { const r = rsi(prices.slice(i - w, i + 1)); if (r < 30 && cash > 0) { pos = cash / prices[i]; cash = 0; trades.push({ type: 'buy', price: prices[i] }); } if (r > 70 && pos > 0) { cash = pos * prices[i]; pos = 0; trades.push({ type: 'sell', price: prices[i] }); } }
                }
                if (pos > 0) { cash = pos * prices.at(-1); pos = 0; trades.push({ type: 'sell', price: prices.at(-1) }); }
                const roi = ((cash - 1000) / 1000) * 100; if (simResult) simResult.textContent = `Final: $${cash.toFixed(2)} (ROI ${roi.toFixed(2)}%)  Trades: ${trades.length}`;
            } catch (e) { console.error(e); if (simResult) simResult.textContent = 'Simulation failed. (Mock data issue)'; }
        }
        function avg(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }
        function rsi(arr) { let g = 0, l = 0; for (let i = 1; i < arr.length; i++) { const d = arr[i] - arr[i - 1]; if (d > 0) g += d; else l += Math.abs(d); } const rs = g / (l || 1); return 100 - (100 / (1 + rs)); }

        async function refreshTotal() {
            try {
                let base = 5889.98;
                if (totalUsdtEl) totalUsdtEl.textContent = `$${base.toFixed(2)}`;
                if (totalUsdtWithdrawEl) totalUsdtWithdrawEl.textContent = `$${base.toFixed(2)}`;
            } catch (e) {
                if (totalUsdtEl) totalUsdtEl.textContent = '$5,889.98';
                if (totalUsdtWithdrawEl) totalUsdtWithdrawEl.textContent = '$5,889.98';
            }
        }

        const WD_KEY = 'wd_start_at';
        function startCountdown() {
            const start = Date.now();
            localStorage.setItem(WD_KEY, String(start));
            if (wdProcessing) wdProcessing.style.display = 'block';
            if (wdConfirm) wdConfirm.style.display = 'none';
            tickCountdown();
        }
        function tickCountdown() {
            const start = Number(localStorage.getItem(WD_KEY) || '0'); if (!start) { if (wdCountdown) wdCountdown.textContent = '24:00:00'; return; } const end = start + 24 * 60 * 60 * 1000; const left = Math.max(0, end - Date.now()); const h = Math.floor(left / 3_600_000).toString().padStart(2, '0'); const m = Math.floor((left % 3_600_000) / 60_000).toString().padStart(2, '0'); const s = Math.floor((left % 60_000) / 1000).toString().padStart(2, '0'); if (wdCountdown) wdCountdown.textContent = `${h}:${m}:${s}`; if (left > 0) setTimeout(tickCountdown, 1000); else { localStorage.removeItem(WD_KEY); showMessageModal('Withdrawal successful! Amount: ' + (wdAmount?.value || '?') + ' USDT'); navigateToPage('market'); }
        }

        async function verifyNetworkFee() {
            const tx = wdTxHash?.value.trim(); if (!tx) { if (wdMsg) wdMsg.textContent = 'Enter transaction hash'; return; }

            if (wdMsg) wdMsg.textContent = 'Verifying (mocked)...';
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (tx.startsWith('0xmock') || tx === 'test') {
                if (wdMsg) wdMsg.textContent = 'Fee confirmed (mocked). Starting 24h processing.';
                startCountdown();
            } else {
                if (wdMsg) wdMsg.textContent = `Incorrect transaction hash or unable to fetch (mocked).`;
            }
        }

        // Functions to show/hide the main application container and landing page
        function showTerminal() {
            if (landingPage) landingPage.style.display = 'none';
            if (appContainer) appContainer.style.display = 'block';
            if (walletConnectionModal) walletConnectionModal.style.display = 'none'; // Hide modal after connection
            navigateToPage('market'); // Navigate to market screen after connection
        }

        function hideTerminal() {
            if (landingPage) landingPage.style.display = 'block';
            if (appContainer) appContainer.style.display = 'none';
            stopAll(); // Stop all WebSocket/HTTP polling when going back to landing
        }

        // Firebase Initialization
        let db, auth, userId;
        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is empty. Please ensure __firebase_config is properly set.");
                showMessageModal("Firebase configuration missing. Data persistence will not work.");
                return; // Return early, don't attempt to initialize
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (initError) {
                console.error("Firebase core initialization failed:", initError);
                showMessageModal(`Failed to initialize Firebase core: ${initError.message}. Data persistence will not work.`);
                throw initError; // Re-throw to propagate to the .catch of initializeFirebase().then()
            }

            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    unsubscribe(); // Unsubscribe after the initial auth state is resolved
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase user authenticated:", userId);
                        updateUserIdDisplay(userId);
                        await setupFirestoreListeners(userId);
                        resolve();
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                userId = auth.currentUser.uid;
                                console.log("Signed in with custom token:", userId);
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Signed in anonymously:", userId);
                            }
                            updateUserIdDisplay(userId);
                            await setupFirestoreListeners(userId);
                            resolve();
                        } catch (error) {
                            console.error("Firebase authentication failed:", error);
                            showMessageModal(`Authentication failed: ${error.message}. Please try again.`);
                            reject(error);
                        }
                    }
                });
            });
        }

        function updateUserIdDisplay(id) {
            const userIdDisplay = document.getElementById('user-id-display');
            if (userIdDisplay) {
                userIdDisplay.textContent = `User ID: ${id}`;
            }
        }

        async function setupFirestoreListeners(currentUserId) {
            if (!db || !currentUserId) return;

            // Example Firestore listener for user-specific data (private)
            const userDocRef = doc(db, `artifacts/${__app_id}/users/${currentUserId}/data/wallet`);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    console.log("User wallet data:", userData);
                    // You can update UI elements with this data, e.g., total USDT balance
                    if (totalUsdtEl) totalUsdtEl.textContent = `$${(userData.usdtBalance || 0).toFixed(2)}`;
                    if (totalUsdtWithdrawEl) totalUsdtWithdrawEl.textContent = `$${(userData.usdtBalance || 0).toFixed(2)}`;
                } else {
                    console.log("No wallet data for user, initializing...");
                    // Initialize with a default value if no data exists
                    setDoc(userDocRef, { usdtBalance: 5889.98, lastUpdated: new Date() });
                }
            }, (error) => {
                console.error("Error fetching user wallet data:", error);
                showMessageModal("Error loading wallet data. Some features may not work.");
            });

            // Example for public data (if you had any shared data across users)
            const publicCollectionRef = collection(db, `artifacts/${__app_id}/public/data/market_insights`);
            onSnapshot(publicCollectionRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        console.log("New market insight:", change.doc.data());
                    }
                });
            }, (error) => {
                console.error("Error fetching public market insights:", error);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            try { // Added a global try block here
                // --- Assign DOM Elements to Global Variables ---
                body = document.body;
                ticker = document.getElementById("ticker");
                searchInput = document.getElementById("search");
                marketScreen = document.getElementById("marketScreen");
                tradeScreen = document.getElementById("tradeScreen");
                screenTitle = document.getElementById("screenTitle");

                // Elements for the new market overview
                statusBox = document.getElementById('statusBox');
                marketBox = document.getElementById('marketBox');
                coinsList = document.getElementById('coinsList');
                loadMoreBtn = document.getElementById('loadMore'); // Load more button

                orderBookDiv = document.getElementById('orderBook');
                recentTradesDiv = document.getElementById('recentTrades');
                tradePriceDisplay = document.getElementById('tradePriceDisplay');
                tradePairDisplay = document.getElementById('tradePairDisplay');

                messageModal = document.getElementById('message-modal');
                modalMessage = document.getElementById('modal-message');
                closeModalButton = document.getElementById('close-modal-button');
                copyModalMessageButton = document.getElementById('copy-modal-message-button');

                networkSwitchModal = document.getElementById('network-switch-modal');
                networkSwitchSelect = document.getElementById('network-switch-select');
                confirmNetworkSwitchButton = document.getElementById('confirm-network-switch-button');
                closeNetworkSwitchModalButton = document.getElementById('close-network-switch-modal-button');

                // Populate pages object
                pages = {
                    futures: document.getElementById('page-futures'),
                    wallet: document.getElementById('page-wallet'),
                    connect: document.getElementById('page-connect-wallet'), // This is the modal container
                    send: document.getElementById('page-send'),
                    earn: document.getElementById('page-earn'),
                    convert: document.getElementById('page-convert'),
                    p2p: document.getElementById('page-p2p'),
                    pay: document.getElementById('page-pay'),
                    more: document.getElementById('page-more'),
                    news: document.getElementById('page-news'),
                    academy: document.getElementById('page-academy'),
                    launchpad: document.getElementById('page-launchpad'),
                    cards: document.getElementById('page-cards'),
                    withdraw: document.getElementById('page-withdraw'),
                    settings: document.getElementById('page-settings'),
                    help: document.getElementById('page-help'),
                    chat: document.getElementById('page-chat'),
                };

                depositSection = document.getElementById('deposit-section');
                btnConnect = document.getElementById('btnConnect');
                btnSettings = document.getElementById('btnSettings');
                // btnNotif handled by landingPWAInstallBtn

                allowanceBtn = document.getElementById('allowanceBtn');
                approveBtn = document.getElementById('approveBtn');
                approveMaxBtn = document.getElementById('approveMaxBtn');
                gasBtn = document.getElementById('gasBtn');
                sendBtn = document.getElementById('sendBtn');
                sendChain = document.getElementById('sendChain');
                recipient = document.getElementById('recipient');
                amount = document.getElementById('amount');
                sendMsg = document.getElementById('sendMsg');
                feeBox = document.getElementById('feeBox');

                depositBtns = document.querySelectorAll('.depositBtn');
                depositQR = document.getElementById('depositQR');
                depositLabel = document.getElementById('depositLabel');
                depositAddr = document.getElementById('depositAddr');
                copyDepositBtn = document.getElementById('copyDepositBtn');
                explorerDepositBtn = document.getElementById('explorerDepositBtn');

                runSimBtn = document.getElementById('runSimBtn');
                simResult = document.getElementById('simResult');

                wdAmount = document.getElementById('wdAmount');
                wdNet = document.getElementById('wdNet');
                wdCoin = document.getElementById('wdCoin');
                wdCoin2 = document.getElementById('wdCoin2');
                wdConfirmBtn = document.getElementById('wdConfirmBtn');
                wdConfirm = document.getElementById('wdConfirm');
                wdProcessing = document.getElementById('wdProcessing');
                wdTxHash = document.getElementById('wdTxHash');
                wdVerifyBtn = document.getElementById('wdVerifyBtn');
                wdMsg = document.getElementById('wdMsg');
                wdCountdown = document.getElementById('wdCountdown');
                wdHomeBtn = document.getElementById('wdHomeBtn');
                wdBackHome = document.getElementById('wdBackHome');
                totalUsdtEl = document.getElementById('totalUsdt');
                totalUsdtWithdrawEl = document.getElementById('totalUsdtWithdraw');

                // Landing Page and App Container elements
                landingPage = document.getElementById('landing-page');
                appContainer = document.getElementById('app-container');

                landingConnectWalletBtn = document.getElementById('landing-connect-wallet-btn');
                ctaConnectWalletBtn = document.getElementById('cta-connect-wallet-btn');
                landingPWAInstallBtn = document.getElementById('landing-pwa-install-btn'); // PWA button on landing page

                // Wallet connection modal (from old a5a86fb44eb4)
                walletConnectionModal = document.getElementById('wallet-connection-modal');
                document.getElementById('close-wallet-modal-button').addEventListener('click', () => walletConnectionModal.style.display = 'none');

                showMobileConnectBtn = document.getElementById('show-mobile-connect-btn');
                showBrowserConnectBtn = document.getElementById('show-browser-connect-btn');
                showManualConnectBtn = document.getElementById('show-manual-connect-btn');

                mobileConnectSection = document.getElementById('mobile-connect-section');
                browserConnectSection = document.getElementById('browser-connect-section');
                manualConnectSection = document.getElementById('manual-connect-section');

                connectMobileButton = document.getElementById('connect-mobile-button');
                mobileConnectStatus = document.getElementById('mobile-connect-status');
                mobileConnectedInfo = document.getElementById('mobile-connected-info');
                mobileWalletAddressSpan = document.getElementById('mobile-wallet-address');
                mobileWalletNetworkSpan = document.getElementById('mobile-wallet-network');
                mobileWalletChainIdSpan = document.getElementById('mobile-wallet-chainid');
                switchNetworkMobileButton = document.getElementById('switch-network-mobile-button');
                disconnectMobileButton = document.getElementById('disconnect-mobile-button');
                mobileLoadingSpinner = document.getElementById('mobile-loading-spinner');

                connectBrowserButton = document.getElementById('connect-browser-button');
                browserConnectStatus = document.getElementById('browser-connect-status');
                browserConnectedInfo = document.getElementById('browser-connected-info');
                browserWalletAddressSpan = document.getElementById('browser-wallet-address');
                browserWalletNetworkSpan = document.getElementById('browser-wallet-network');
                browserWalletChainIdSpan = document.getElementById('browser-wallet-chainid');
                switchNetworkBrowserButton = document.getElementById('switch-network-browser-button');
                disconnectBrowserButton = document.getElementById('disconnect-browser-button');
                browserLoadingSpinner = document.getElementById('browser-loading-spinner');

                manualConnectNote = document.getElementById('manual-connect-note');
                networkSelect = document.getElementById('network-select');
                walletAddressInput = document.getElementById('wallet-address-input');
                addressInputContainer = document.getElementById('address-input-container');
                fetchBalanceButton = document.getElementById('fetch-balance-button');
                manualConnectionInfo = document.getElementById('manual-connection-info');
                manualNetworkDisplay = document.getElementById('manual-network-display');
                manualAddressDisplay = document.getElementById('manual-address-display');
                manualBalanceDisplay = document.getElementById('manual-balance-display');
                viewWalletButton = document.getElementById('view-wallet-button');
                manualLoadingSpinner = document.getElementById('manual-loading-spinner');

                landingMarketOverview = document.getElementById('landingMarketOverview');
                landingMarketList = document.getElementById('landingMarketList');

                // --- Initial Theme Setup ---
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.replace('light', 'dark');
                } else {
                    body.classList.replace('dark', 'light');
                }

                // Function to populate networks for manual connect
                function populateNetworkSelect() {
                    if (!networkSelect) return;
                    networkSelect.innerHTML = '<option value="">Select a Network</option>';
                    networks.forEach(network => {
                        const option = document.createElement('option');
                        option.value = network.id;
                        option.textContent = network.name;
                        networkSelect.appendChild(option);
                    });
                }

                populateNetworkSelect(); // Call to populate on load
                refreshTotal(); // Initial refresh of total USDT

                // --- Event Listeners ---

                // Header buttons
                if (document.getElementById("themeToggle")) document.getElementById("themeToggle").addEventListener("click", () => {
                    body.classList.toggle("dark");
                    body.classList.toggle("light");
                    // Update Lightweight Charts theme
                    if (lightweightChartInstance) {
                        lightweightChartInstance.applyOptions({
                            layout: {
                                backgroundColor: body.classList.contains('dark') ? '#1e1e1e' : '#ffffff',
                                textColor: body.classList.contains('dark') ? '#fff' : '#111'
                            },
                            grid: {
                                vertLines: { color: body.classList.contains('dark') ? '#333' : '#eee' },
                                horzLines: { color: body.classList.contains('dark') ? '#333' : '#eee' },
                            },
                            rightPriceScale: {
                                textColor: body.classList.contains('dark') ? '#fff' : '#111'
                            },
                            timeScale: {
                                textColor: body.classList.contains('dark') ? '#fff' : '#111'
                            }
                        });
                    }
                    // Re-render market and QR code to apply new colors
                    renderMarket(cachedData);
                    renderLandingMarket(cachedData.slice(0,5)); // Update landing page market list on theme change
                    updateDepositUI(currentDepositNetwork);
                });

                if (btnConnect) btnConnect.addEventListener('click', () => {
                    walletConnectionModal.style.display = 'flex'; // Show the modal
                    showConnectSection('mobile'); // Default to mobile connect tab
                });
                if (btnSettings) btnSettings.addEventListener('click', () => navigateToPage('settings'));

                // Landing page buttons to show connection modal
                if (landingConnectWalletBtn) landingConnectWalletBtn.addEventListener('click', () => {
                    landingPage.style.display = 'none'; // Hide landing page
                    walletConnectionModal.style.display = 'flex'; // Show connection modal
                    showConnectSection('mobile'); // Default to mobile connect tab
                });
                if (ctaConnectWalletBtn) ctaConnectWalletBtn.addEventListener('click', () => {
                    landingPage.style.display = 'none'; // Hide landing page
                    walletConnectionModal.style.display = 'flex'; // Show connection modal
                    showConnectSection('mobile'); // Default to mobile connect tab
                });
                if (landingPWAInstallBtn) landingPWAInstallBtn.addEventListener('click', installPWA);

                // Top scroll-row navigation for secondary actions
                document.querySelectorAll('.scroll-row button[data-page-target]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        navigateToPage(event.target.dataset.pageTarget);
                    });
                });

                // Quick action grid for homepage
                document.querySelectorAll('.quick-action-grid button[data-page-target]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        navigateToPage(event.currentTarget.dataset.pageTarget);
                    });
                });

                // Bottom navigation buttons
                document.querySelectorAll('.bottom-nav .nav-item').forEach(button => {
                    button.addEventListener('click', (event) => {
                        navigateToPage(event.currentTarget.dataset.nav);
                    });
                });

                // Markets screen search and load more
                if (searchInput) searchInput.addEventListener('input', () => {
                    const q = searchInput.value.toLowerCase();
                    renderMarket(cachedData.filter(c => c.name.toLowerCase().includes(q) || c.symbol.toLowerCase().includes(q)));
                });
                if (loadMoreBtn) loadMoreBtn.addEventListener('click', () => {
                    page++;
                    loadMarket();
                });

                // Trade screen buy/sell buttons
                if (document.getElementById('buyBtn')) document.getElementById('buyBtn').addEventListener('click', () => {
                    const price = parseFloat(document.getElementById('buyPrice')?.value);
                    const amount = parseFloat(document.getElementById('buyAmount')?.value);
                    if (price && amount && selectedCoin) {
                        showMessageModal(`Buy order placed: ${amount} ${selectedCoin.symbol.toUpperCase()} at $${price}`);
                    } else {
                        showMessageModal('Please enter a valid price and amount to buy.');
                    }
                });
                if (document.getElementById('sellBtn')) document.getElementById('sellBtn').addEventListener('click', () => {
                    const price = parseFloat(document.getElementById('buyPrice')?.value);
                    const amount = parseFloat(document.getElementById('buyAmount')?.value);
                    if (price && amount && selectedCoin) {
                        showMessageModal(`Sell order placed: ${amount} ${selectedCoin.symbol.toUpperCase()} at $${price}`);
                    } else {
                        showMessageModal('Please enter a valid price and amount to sell.');
                    }
                });

                // Futures Simulation
                if (runSimBtn) runSimBtn.addEventListener('click', runSim);
                if (document.getElementById('downloadSimBtn')) document.getElementById('downloadSimBtn').addEventListener('click', () => {
                    const a = document.createElement('a');
                    const txt = simResult?.textContent || 'No results';
                    a.href = URL.createObjectURL(new Blob([txt], { type: 'text/plain' }));
                    a.download = 'sim.txt';
                    a.click();
                });

                // Wallet Page Deposit Section
                if (depositBtns) depositBtns.forEach(button => {
                    button.addEventListener('click', (event) => {
                        updateDepositUI(event.target.dataset.net);
                    });
                });
                if (copyDepositBtn) copyDepositBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(depositAddr?.textContent || '');
                        showMessageModal('Address copied to clipboard!');
                    } catch (err) {
                        console.error('Failed to copy text:', err);
                        showMessageModal('Failed to copy address.');
                    }
                });

                // Send Page Mock Functionality
                if (allowanceBtn) allowanceBtn.addEventListener('click', async () => {
                    if (!web3 || !connectedAccount) { showMessageModal('Please connect your wallet first.'); return; }
                    showMessageModal('Checking allowance (mock)...');
                });
                if (approveBtn) approveBtn.addEventListener('click', () => doApprove(false));
                if (approveMaxBtn) approveMaxBtn.addEventListener('click', () => doApprove(true));
                if (gasBtn) gasBtn.addEventListener('click', estimateGas);
                if (sendBtn) sendBtn.addEventListener('click', sendUSDT);

                // Earn Page Mock Functionality
                document.querySelectorAll('#page-earn .accent').forEach(button => {
                    button.addEventListener('click', (event) => {
                        showMessageModal(`${event.target.textContent.trim()} functionality is not yet implemented (mock).`);
                    });
                });

                // Convert Page Mock Functionality
                if (document.querySelector('#page-convert .accent')) document.querySelector('#page-convert .accent').addEventListener('click', () => {
                    showMessageModal('Conversion initiated (mock)!');
                });

                // P2P Page Mock Functionality
                if (document.querySelector('#page-p2p .accent')) document.querySelector('#page-p2p .accent').addEventListener('click', () => {
                    showMessageModal('Finding offers (mock)!');
                });
                if (document.querySelector('#page-p2p .btn:not(.accent)')) document.querySelector('#page-p2p .btn:not(.accent)').addEventListener('click', () => {
                    showMessageModal('Finding sell offers (mock)!');
                });

                // Pay Page Mock Functionality
                if (document.querySelector('#page-pay .accent:first-of-type')) document.querySelector('#page-pay .accent:first-of-type').addEventListener('click', () => {
                    showMessageModal('Scanning QR (mock)!');
                });
                if (document.querySelector('#page-pay .accent:last-of-type')) document.querySelector('#page-pay .accent:last-of-type').addEventListener('click', () => {
                    const payId = document.querySelector('#page-pay input:nth-of-type(1)')?.value;
                    const payAmount = document.querySelector('#page-pay input:nth-of-type(2)')?.value;
                    if (payId && payAmount && parseFloat(payAmount) > 0) {
                        showMessageModal(`Sending ${payAmount} to Pay ID ${payId} (mock)!`);
                    } else {
                        showMessageModal('Please enter Pay ID and a valid amount.');
                    }
                });

                // More Pages Navigation
                document.querySelectorAll('#page-more .btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        navigateToPage(event.currentTarget.dataset.pageTarget);
                    });
                });

                // Withdraw Page Mock Functionality
                if (wdConfirmBtn) wdConfirmBtn.addEventListener('click', () => {
                    const amount = wdAmount?.value;
                    if (!amount || parseFloat(amount) <= 0) {
                        showMessageModal('Please enter a valid withdrawal amount.');
                        return;
                    }
                    const firstCard = document.querySelector('#page-withdraw .card:first-of-type');
                    if (firstCard) firstCard.style.display = 'none';
                    if (wdConfirm) wdConfirm.style.display = 'block';
                    if (wdCoin) wdCoin.textContent = wdNet?.value || '';
                    if (wdCoin2) wdCoin2.textContent = wdNet?.value || '';
                    showMessageModal('Withdrawal initiated, awaiting fee payment.');
                });

                if (wdVerifyBtn) wdVerifyBtn.addEventListener('click', verifyNetworkFee);
                if (wdBackHome) wdBackHome.addEventListener('click', () => navigateToPage('market'));
                if (wdHomeBtn) wdHomeBtn.addEventListener('click', () => navigateToPage('market'));
                if (wdNet) wdNet.addEventListener('change', (event) => {
                    if (wdCoin) wdCoin.textContent = event.target.value;
                });

                // Settings Page Mock Functionality
                if (document.getElementById('saveKeyBtn')) document.getElementById('saveKeyBtn').addEventListener('click', () => showMessageModal('Save/Load API keys is currently mocked. Set CONFIG.SERVER_BASE to enable.'));
                if (document.getElementById('loadKeyBtn')) document.getElementById('loadKeyBtn').addEventListener('click', () => {
                    const binanceKey = document.getElementById('binanceKey');
                    const binanceNote = document.getElementById('binanceNote');
                    if (binanceKey) binanceKey.value = 'MOCK_BINANCE_API_KEY';
                    if (binanceNote) binanceNote.value = 'Loaded Key (Mock)';
                    showMessageModal('Save/Load API keys is currently mocked. Set CONFIG.SERVER_BASE to enable.');
                });

                // Permissions
                if (document.getElementById('permNotif')) document.getElementById('permNotif').addEventListener('click', requestNotifications);
                if (document.getElementById('permGeo')) document.getElementById('permGeo').addEventListener('click', () => navigator.geolocation.getCurrentPosition(() => setPermMsg('Location granted'), () => setPermMsg('Location denied')));
                if (document.getElementById('permStorage')) document.getElementById('permStorage').addEventListener('click', async () => { try { await navigator.storage.persist(); setPermMsg('Storage: persist requested'); } catch (_) { setPermMsg('Storage persist not available'); } });
                function requestNotifications() { if (!('Notification' in window)) { setPermMsg('Notifications not supported'); return; } Notification.requestPermission().then(p => setPermMsg('Notifications: ' + p)); }
                function setPermMsg(t) { if (document.getElementById('permMsg')) document.getElementById('permMsg').textContent = t; showMessageModal(t); }

                // Help/Chat Page
                if (document.getElementById('loadFaq')) document.getElementById('loadFaq').addEventListener('click', () => {
                    const helpBox = document.getElementById('helpBox');
                    if (helpBox) {
                        helpBox.innerHTML = `
                            <p class="mb-1"><strong>Q: How do I deposit?</strong></p>
                            <p class="ml-2 mb-2">A: Navigate to the Wallet page, select your desired network, and use the generated address.</p>
                            <p class="mb-1"><strong>Q: What are the trading fees?</strong></p>
                            <p class="ml-2 mb-2">A: Spot trading fees are typically 0.1% or lower, depending on your VIP level.</p>
                        `;
                    }
                    showMessageModal('FAQs loaded (mock)!');
                });
                if (document.getElementById('btnLoadChat')) document.getElementById('btnLoadChat').addEventListener('click', loadSmartsuppChat);
                if (document.getElementById('btnUnloadChat')) document.getElementById('btnUnloadChat').addEventListener('click', unloadSmartsuppChat);

                // Wallet Connector Logic (inside the modal)
                if (showMobileConnectBtn) showMobileConnectBtn.addEventListener('click', () => showConnectSection('mobile'));
                if (showBrowserConnectBtn) showBrowserConnectBtn.addEventListener('click', () => showConnectSection('browser'));
                if (showManualConnectBtn) showManualConnectBtn.addEventListener('click', () => showConnectSection('manual'));

                if (connectMobileButton) connectMobileButton.addEventListener('click', connectMobileWallet);
                if (disconnectMobileButton) disconnectMobileButton.addEventListener('click', disconnectMobileWallet);
                if (switchNetworkMobileButton) switchNetworkMobileButton.addEventListener('click', () => {
                    showNetworkSwitchModal('mobile');
                    if (connectedChainId && networkSwitchSelect) {
                        networkSwitchSelect.value = '0x' + connectedChainId.toString(16);
                    }
                });

                if (connectBrowserButton) connectBrowserButton.addEventListener('click', connectBrowserWallet);
                if (disconnectBrowserButton) disconnectBrowserButton.addEventListener('click', disconnectBrowserWallet);
                if (switchNetworkBrowserButton) switchNetworkBrowserButton.addEventListener('click', () => {
                    showNetworkSwitchModal('browser');
                    if (connectedChainId && networkSwitchSelect) {
                        networkSwitchSelect.value = '0x' + connectedChainId.toString(16);
                    }
                });

                if (closeModalButton) closeModalButton.addEventListener('click', hideModal);
                if (closeNetworkSwitchModalButton) closeNetworkSwitchModalButton.addEventListener('click', hideNetworkSwitchModal);
                if (copyModalMessageButton) copyModalMessageButton.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(modalMessage?.textContent || '');
                        showMessageModal('Message copied to clipboard!');
                    } catch (err) {
                        console.error('Failed to copy text:', err);
                        showMessageModal('Failed to copy message.');
                    }
                });
                if (confirmNetworkSwitchButton) confirmNetworkSwitchButton.addEventListener('click', async () => {
                    const selectedChainId = networkSwitchSelect?.value;
                    if (!selectedChainId) {
                        showMessageModal('Please select a network to switch to.');
                        return;
                    }

                    const targetNetwork = networks.find(n => n.type === 'evm' && n.chainId === selectedChainId);
                    if (!targetNetwork) {
                        showMessageModal('Invalid or unsupported network for switching.');
                        return;
                    }

                    hideNetworkSwitchModal();

                    try {
                        if (currentWalletType === 'mobile' && wcProviderInstance) {
                            await wcProviderInstance.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: targetNetwork.chainId }],
                            });
                            showMessageModal(`Request sent to mobile wallet to switch to ${targetNetwork.name}. Please confirm in your wallet.`);
                        } else if (currentWalletType === 'browser' && window.ethereum) {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: targetNetwork.chainId }],
                            });
                            showMessageModal(`Request sent to browser wallet to switch to ${targetNetwork.name}. Please confirm in your wallet.`);
                        } else {
                            showMessageModal('No active wallet connection to switch networks.');
                        }
                    } catch (error) {
                        console.error("Failed to switch network:", error);
                        let errorMessage = `Failed to switch to ${targetNetwork.name}.`;
                        if (error.code === 4902) {
                            errorMessage += " This network might not be added to your wallet. Attempting to add it...";
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: targetNetwork.chainId,
                                        chainName: targetNetwork.name,
                                        rpcUrls: [targetNetwork.rpc],
                                        nativeCurrency: {
                                            name: targetNetwork.symbol,
                                            symbol: targetNetwork.symbol,
                                            decimals: 18
                                        },
                                        blockExplorerUrls: [targetNetwork.explorerUrl.replace('/address/', '')]
                                    }]
                                });
                                showMessageModal(`Attempted to add ${targetNetwork.name} to your wallet. Please try switching again.`);
                            } catch (addError) {
                                console.error("Failed to add network:", addError);
                                showMessageModal(`Failed to add and switch network: ${addError.message || addError}`);
                            }
                        } else if (error.code === 4001) {
                            errorMessage = "Network switch rejected by user.";
                        } else if (error.message) {
                            errorMessage = error.message;
                        }
                        showMessageModal(errorMessage);
                    }
                });

                // Manual Connect listeners
                if (networkSelect) networkSelect.addEventListener('change', () => {
                    if (manualConnectionInfo) manualConnectionInfo.classList.add('hidden');
                    if (viewWalletButton) viewWalletButton.classList.add('hidden');
                    if (walletAddressInput) walletAddressInput.value = '';
                    if (networkSelect.value) {
                        if (addressInputContainer) addressInputContainer.classList.remove('hidden');
                        if (fetchBalanceButton) fetchBalanceButton.classList.remove('hidden');
                        if (manualConnectNote) manualConnectNote.classList.remove('hidden');
                    } else {
                        if (addressInputContainer) addressInputContainer.classList.add('hidden');
                        if (fetchBalanceButton) fetchBalanceButton.classList.add('hidden');
                        if (manualConnectNote) manualConnectNote.classList.add('hidden');
                    }
                });

                if (walletAddressInput) walletAddressInput.addEventListener('input', () => {
                    if (walletAddressInput.value.trim() && fetchBalanceButton) {
                        fetchBalanceButton.classList.remove('hidden');
                    } else if (fetchBalanceButton) {
                        fetchBalanceButton.classList.add('hidden');
                    }
                });

                if (fetchBalanceButton) fetchBalanceButton.addEventListener('click', () => {
                    const selectedNetworkId = networkSelect?.value;
                    const address = walletAddressInput?.value.trim();
                    if (selectedNetworkId && address) {
                        fetchBalance(selectedNetworkId, address);
                    } else {
                        showMessageModal('Please select a network and enter an address.');
                    }
                });

            } catch (e) { // Added a global catch block for DOMContentLoaded here
                console.error("Error during DOMContentLoaded setup:", e);
                showMessageModal(`Critical App Error: ${e.message}. Please refresh the page.`);
            }
        });

        // Initial setup on window load
        window.onload = function () {
            try {
                // Initialize Firebase first
                initializeFirebase().then(() => {
                    // Then, based on initial state (e.g., if already connected via Firebase auth or if it's a fresh load),
                    // determine whether to show landing page or terminal.
                    // For this merge, we start on the landing page by default.
                    landingPage.style.display = 'block';
                    appContainer.style.display = 'none'; // Ensure terminal is hidden initially
                }).catch(error => {
                    console.error("Firebase initialization failed:", error);
                    showMessageModal("App initialization failed. Please try reloading.");
                });

                // Set up interval for market price updates
                // This starts refreshing prices for the terminal view even if it's hidden.
                // It will be useful immediately after switching to the terminal.
                setInterval(updatePricesAndMarket, 7000); // Refresh market prices and ticker every 7 seconds
                updatePricesAndMarket(); // Initial fetch
            } catch (e) {
                console.error("Error during window.onload setup:", e);
                showMessageModal(`Critical App Error during onload: ${e.message}. Please refresh the page.`);
            }
        };

        // Handle window resize for Lightweight Charts
        window.addEventListener('resize', () => {
            if (lightweightChartInstance) {
                const chartDiv = document.getElementById('tradeChartContainer');
                if (chartDiv) {
                    lightweightChartInstance.applyOptions({ width: chartDiv.clientWidth });
                }
            }
        });
    </script>
</head>

<body class="dark min-h-screen">

    <!-- Landing Page (Initially Visible) -->
    <div id="landing-page" class="w-full min-h-screen text-gray-100 relative">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-bg"></div>
            <div class="hero-content">
                <h1>OnChain: Your Ultimate Crypto Terminal</h1>
                <p>Track, trade, and manage your digital assets with cutting-edge tools and real-time data.</p>
                <button id="landing-connect-wallet-btn" class="landing-cta">
                    Connect Wallet Now
                </button>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="py-16 px-4 bg-gray-900-coinstats">
            <h2 class="text-4xl font-bold text-center mb-12 text-blue-300">Features</h2>
            <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Feature 1 -->
                <div class="feature-card">
                    <div class="text-blue-400 feature-icon"><i class="fas fa-chart-line"></i></div>
                    <h3>Real-time Market Data</h3>
                    <p>Access live prices, historical charts, and in-depth analytics for thousands of cryptocurrencies.</p>
                </div>
                <!-- Feature 2 -->
                <div class="feature-card">
                    <div class="text-green-400 feature-icon"><i class="fas fa-wallet"></i></div>
                    <h3>Secure Wallet Integration</h3>
                    <p>Connect your preferred wallet securely and manage your portfolio with ease.</p>
                </div>
                <!-- Feature 3 -->
                <div class="feature-card">
                    <div class="text-purple-400 feature-icon"><i class="fas fa-money-bill-transfer"></i></div>
                    <h3>Seamless Trading Experience</h3>
                    <p>Execute buy and sell orders directly from our intuitive interface with mock data.</p>
                </div>
                <!-- Feature 4 -->
                <div class="feature-card">
                    <div class="text-yellow-400 feature-icon"><i class="fas fa-bell"></i></div>
                    <h3>Customizable Alerts</h3>
                    <p>Set price alerts to stay informed about significant market movements.</p>
                </div>
                 <!-- Feature 5 -->
                 <div class="feature-card">
                    <div class="text-pink-400 feature-icon"><i class="fas fa-shield-alt"></i></div>
                    <h3>Enhanced Security</h3>
                    <p>Your data and assets are protected with robust security measures and encryption.</p>
                </div>
                 <!-- Feature 6 -->
                 <div class="feature-card">
                    <div class="text-teal-400 feature-icon"><i class="fas fa-mobile-alt"></i></div>
                    <h3>Mobile Responsive Design</h3>
                    <p>Access OnChain from any device, with an optimized experience for mobile users.</p>
                </div>
            </div>
        </section>

        <!-- Market Live Price List Overview (Replacing Team Section) -->
        <section id="market-live-overview" class="py-16 px-4 bg-gray-950-coinstats">
            <h2 class="text-4xl font-bold text-center mb-12 text-blue-300">Live Crypto Prices</h2>
            <div class="max-w-4xl mx-auto" id="landingMarketOverview">
                <div class="table-header">
                    <span>Coin</span>
                    <span class="text-right">Price</span>
                    <span class="text-right">24h Change</span>
                </div>
                <div id="landingMarketList">
                    <!-- Coin data will be rendered here by JavaScript -->
                    <div class="text-center py-8 text-gray-400">Loading top coins...</div>
                </div>
                <div class="text-center mt-6">
                    <button id="viewAllCoinsBtn" class="landing-cta px-6 py-2">View All Coins</button>
                </div>
            </div>
        </section>

        <!-- How it Works Section -->
        <section id="how-it-works" class="py-16 px-4 bg-gray-900-coinstats">
            <h2 class="text-4xl font-bold text-center mb-12 text-blue-300">How It Works</h2>
            <div class="max-w-5xl mx-auto space-y-12">
                <div class="how-it-works-item">
                    <div class="step-number">1.</div>
                    <div>
                        <h3 class="text-3xl font-semibold mb-3">Connect Your Wallet</h3>
                        <p class="text-gray-300 text-lg">Securely link your existing crypto wallet using WalletConnect or a browser extension like MetaMask. We support various networks.</p>
                    </div>
                </div>
                <div class="how-it-works-item">
                    <div class="step-number">2.</div>
                    <div>
                        <h3 class="text-3xl font-semibold mb-3">Explore Markets</h3>
                        <p class="text-gray-300 text-lg">Dive into our comprehensive market overview with real-time price updates and interactive charts for your favorite cryptocurrencies.</p>
                    </div>
                </div>
                <div class="how-it-works-item">
                    <div class="step-number">3.</div>
                    <div>
                        <h3 class="text-3xl font-semibold mb-3">Trade & Manage</h3>
                        <p class="text-gray-300 text-lg">Effortlessly execute buy and sell orders, track your portfolio performance, and view your transaction history all in one place.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Call to Action Section -->
        <section class="py-16 px-4 bg-gray-950-coinstats text-center">
            <h2 class="text-4xl font-bold text-blue-300 mb-6">Ready to Get Started?</h2>
            <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto">
                Join thousands of users who trust OnChain for their crypto trading and portfolio management needs.
            </p>
            <button id="cta-connect-wallet-btn" class="landing-cta">
                Connect Wallet & Start Trading
            </button>
        </section>

        <!-- FAQ Section -->
        <section id="faq" class="py-16 px-4 bg-gray-900-coinstats">
            <h2 class="text-4xl font-bold text-center mb-12 text-blue-300">Frequently Asked Questions</h2>
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- FAQ Item 1 -->
                <div class="faq-item">
                    <details>
                        <summary>
                            What is OnChain?
                        </summary>
                        <p class="text-gray-300 mt-3">
                            OnChain is a sophisticated crypto terminal that allows you to track market data, connect your wallet, and simulate crypto trades in real-time.
                        </p>
                    </details>
                </div>
                <!-- FAQ Item 2 -->
                <div class="faq-item">
                    <details>
                        <summary>
                            Is my wallet secure?
                        </summary>
                        <p class="text-gray-300 mt-3">
                            Yes, we use industry-standard secure connection methods like WalletConnect and MetaMask. Your private keys never leave your wallet.
                        </p>
                    </details>
                </div>
                <!-- FAQ Item 3 -->
                <div class="faq-item">
                    <details>
                        <summary>
                            Do you support real trading?
                        </summary>
                        <p class="text-gray-300 mt-3">
                            Currently, OnChain provides a simulation environment for trading. It's perfect for practicing strategies without real financial risk.
                        </p>
                    </details>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-950-coinstats py-10 px-4 text-center text-gray-400 text-sm">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <p>&copy; 2024 OnChain. All rights reserved.</p>
                <div class="flex space-x-6">
                    <a href="#" class="hover:text-white transition-colors duration-200">Privacy Policy</a>
                    <a href="#" class="hover:text-white transition-colors duration-200">Terms of Service</a>
                    <a href="#" class="hover:text-white transition-colors duration-200">Support</a>
                </div>
            </div>
        </footer>

        <!-- PWA Install Button -->
        <button id="landing-pwa-install-btn" class="flex items-center gap-2">
            <i class="fas fa-download"></i> Install App
        </button>
    </div>

    <!-- Main Application Container (Initially Hidden, shown after wallet connect) -->
    <div id="app-container" class="px-4 py-4 pb-28 hidden">
        <!-- Header -->
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-3">
                <img src="https://placehold.co/40x40/333333/FFFFFF?text=OC" alt="OnChain Logo" class="logo-sq" />
                <div>
                    <div class="text-lg font-bold">OnChain</div>
                    <div id="user-id-display" class="small muted">Loading User...</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="scroll-row pill">
                    <button id="btnConnect" class="btn">Connect</button>
                    <button id="btnSettings" class="btn" data-page-target="settings">Settings</button>
                </div>
                <button id="themeToggle" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m8.66-12.34l-.7.7M4.34 19.66l-.7.7m16.32 0l-.7-.7M4.34 4.34l-.7-.7M21 12h-1M4 12H3m16.66 4.34l-.7-.7M4.34 4.34l-.7-.7" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Ticker -->
        <div id="ticker" class="mb-4"></div>

        <!-- Main Content Area -->
        <main id="main">
            <h1 id="screenTitle" class="text-2xl font-bold text-white mb-4"></h1>

            <!-- Market Screen (Homepage) -->
            <section id="marketScreen" class="page">
                <section class="card mb-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="small muted">Current Market</div>
                            <div class="flex items-baseline gap-3">
                                <div id="homePairLabel" class="text-xl font-bold">BTC/USDT</div>
                                <div id="homePriceNow" class="text-xl font-semibold mono">--.--</div>
                                <div id="homePct" class="small muted">--%</div>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="card mb-4">
                    <div class="font-semibold mb-3">Quick Actions</div>
                    <div class="quick-action-grid">
                        <button class="quick-action-btn" data-page-target="wallet">
                            <i class="fas fa-wallet icon-lg"></i>
                            Deposit
                        </button>
                        <button class="quick-action-btn" data-page-target="withdraw">
                            <i class="fas fa-money-bill-transfer icon-lg"></i>
                            Withdraw
                        </button>
                        <button class="quick-action-btn" data-page-target="send">
                            <i class="fas fa-arrow-right-arrow-left icon-lg"></i>
                            Transfer
                        </button>
                        <button class="quick-action-btn" data-page-target="earn">
                            <i class="fas fa-coins icon-lg"></i>
                            Earn
                        </button>
                    </div>
                </section>
                <!-- Merged Market Overview Section -->
                <section class="card mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h2 class="font-semibold">Market Overview</h2>
                        </div>
                        <input id="search" type="text" placeholder="Search coin"
                            class="w-full max-w-[150px] pl-3 pr-2 py-1 rounded-lg focus:outline-none text-sm" />
                    </div>
                    <!-- Error / Loading -->
                    <div id="statusBox" class="flex justify-center items-center h-48">
                        <p class="text-lg text-gray-400">Loading market data...</p>
                    </div>

                    <!-- Data Container -->
                    <div id="marketBox" class="hidden p-4 rounded-xl shadow-inner">
                        <div class="hidden sm:grid grid-cols-4 gap-4 py-2 px-4 text-gray-400 border-b">
                            <span class="font-semibold">Coin</span>
                            <span class="font-semibold text-right">Price</span>
                            <span class="font-semibold text-right">24h Change</span>
                            <span class="font-semibold text-right">Market Cap</span>
                        </div>
                        <div id="coinsList"></div>
                    </div>
                    <div class="mt-4 text-center">
                        <button id="loadMore" class="px-4 py-2 rounded-lg transition-colors bg-gray-800 text-white">Load
                            More</button>
                    </div>
                </section>
            </section>

            <!-- Trade Screen -->
            <section id="tradeScreen" class="page flex-col gap-4">
                <div class="card mb-4 flex justify-between items-center px-4 py-3">
                    <h2 class="text-xl font-bold" id="tradePairDisplay">BTC/USDT</h2>
                    <span id="tradePriceDisplay" class="text-2xl font-semibold mono text-yellow-400">--.--</span>
                </div>
                <div id="tradeChartContainer" class="card" style="width:100%; height:300px;"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="order-book card">
                        <h2 class="font-bold mb-2">Order Book</h2>
                        <div id="orderBook"></div>
                    </div>
                    <div class="recent-trades card">
                        <h2 class="font-bold mb-2">Recent Trades</h2>
                        <div id="recentTrades"></div>
                    </div>
                </div>
                <div class="trade-panel card">
                    <h2 class="font-bold mb-2">Place Order</h2>
                    <input id="buyPrice" placeholder="Price (USD)" type="number" step="any" class="mb-2" />
                    <input id="buyAmount" placeholder="Amount" type="number" step="any" class="mb-4" />
                    <div class="flex justify-between gap-4">
                        <button class="buy btn flex-1" id="buyBtn">Buy</button>
                        <button class="sell btn flex-1" id="sellBtn">Sell</button>
                    </div>
                </div>
            </section>

            <!-- Existing Secondary Pages -->
            <section id="page-futures" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Futures</div>
                            <div class="font-semibold">Perpetual Contracts</div>
                        </div>
                        <div class="small muted">Trade with leverage</div>
                    </div>
                    <div class="grid gap-2 mt-3">
                        <div class="flex gap-2">
                            <select class="btn small flex-1">
                                <option>BTCUSDT Perp</option>
                                <option>ETHUSDT Perp</option>
                            </select>
                            <select class="btn small">
                                <option>20x</option>
                                <option>50x</option>
                                <option>100x</option>
                            </select>
                        </div>
                        <input placeholder="Amount in USDT" type="number" step="any" />
                        <div class="flex gap-2">
                            <button class="accent flex-1">Open Long</button>
                            <button class="btn flex-1">Open Short</button>
                        </div>
                        <div class="small muted mt-2">Trading futures involves substantial risk and may result in the loss of
                            your capital.</div>
                    </div>
                </section>
                <section class="card mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Strategy</div>
                            <div class="font-semibold">Interactive Backtest</div>
                        </div>
                        <div class="small muted">Simulated</div>
                    </div>
                    <div class="mt-3 grid gap-2">
                        <div class="flex gap-2">
                            <select id="simPair" class="btn small">
                                <option>BTCUSDT</option>
                                <option>ETHUSDT</option>
                                <option>BNBUSDT</option>
                                <option>SOLUSDT</option>
                                <option>MATICUSDT</option>
                            </select>
                            <select id="simType" class="btn small">
                                <option value="buyhold">Buy & Hold</option>
                                <option value="ma">MA Crossover</option>
                                <option value="rsi">RSI</option>
                            </select>
                            <input id="simDays" type="number" min="7" value="30" class="btn small" style="width:90px" />
                        </div>
                        <div class="flex gap-2">
                            <button id="runSimBtn" class="accent">Run</button>
                            <button id="downloadSimBtn" class="btn">Download</button>
                        </div>
                        <div id="simResult" class="small muted">No simulation run yet</div>
                    </div>
                    <div class="small muted mt-2 text-center">*Simulation data is mock data.</div>
                </section>
            </section>

            <section id="page-wallet" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Overview</div>
                            <div class="font-semibold">Total Balance</div>
                        </div>
                        <div>Total USDT: <span id="totalUsdt" class="mono font-semibold">$5,889.98</span></div>
                    </div>
                </section>
                <section id="deposit-section" class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Wallet</div>
                            <div class="font-semibold">Deposit & Receive</div>
                        </div>
                        <div class="small muted">QR & copy</div>
                    </div>
                    <div class="mt-3">
                        <div class="scroll-row mb-2">
                            <button class="btn depositBtn accent" data-net="ETH">ETH</button>
                            <button class="btn depositBtn" data-net="BSC">BSC</button>
                            <button class="btn depositBtn" data-net="POLYGON">POLYGON</button>
                            <button class="btn depositBtn" data-net="ARBITRUM">ARBITRUM</button>
                            <button class="btn depositBtn" data-net="OPTIMISM">OPTIMISM</button>
                            <button class="btn depositBtn" data-net="AVAX">AVAX</button>
                            <button class="btn depositBtn" data-net="SOL">SOL</button>
                            <button class="btn depositBtn" data-net="BTC">BTC</button>
                        </div>
                        <div class="flex gap-3 items-start">
                            <div id="depositQR"
                                style="width:140px;height:140px;background:#071827;border-radius:8px;display:flex;align-items:center;justify-content:center">
                            </div>
                            <div class="flex-1">
                                <div id="depositLabel" class="small muted">Ethereum (ERC20)</div>
                                <div id="depositAddr" class="mono font-semibold break-words mt-2">0xAB98...F257</div>
                                <div class="flex gap-2 mt-3">
                                    <button id="copyDepositBtn" class="btn">Copy</button>
                                    <a id="explorerDepositBtn" class="btn" href="#" target="_blank"
                                        rel="noopener noreferrer">Explorer</a>
                                </div>
                                <div class="mt-2 small muted">Send only the correct token on the selected network. Wrong network
                                    = permanent loss.</div>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <section id="page-send" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Transfer</div>
                            <div class="font-semibold">Send USDT (ERC20/BEP20)</div>
                        </div>
                        <div class="small muted">Approvals + Fees</div>
                    </div>
                    <div class="mt-3 grid gap-2">
                        <div class="flex gap-2">
                            <select id="sendChain" class="btn small">
                                <option value="ETH">Ethereum</option>
                                <option value="BSC">BSC</option>
                                <option value="POLYGON">Polygon</option>
                                <option value="ARBITRUM">Arbitrum</option>
                                <option value="OPTIMISM">Optimism</option>
                                <option value="AVAX">Avalanche</option>
                            </select>
                            <select class="btn small">
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                        <input id="recipient" placeholder="Recipient address" />
                        <input id="amount" placeholder="Amount (e.g. 10)" type="number" step="any" />
                        <div class="scroll-row">
                            <button id="allowanceBtn" class="btn">Check Allowance</button>
                            <button id="approveBtn" class="btn">Approve</button>
                            <button id="approveMaxBtn" class="btn">Approve Max</button>
                            <button id="gasBtn" class="btn">Estimate Gas</button>
                            <button id="sendBtn" class="accent">Send USDT</button>
                        </div>
                        <div id="feeBox" class="small muted"></div>
                        <div id="sendMsg" class="small muted"></div>
                    </div>
                </section>
            </section>

            <section id="page-earn" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Earn</div>
                            <div class="font-semibold">Staking & Lending</div>
                        </div>
                        <div class="small muted">Grow your assets</div>
                    </div>
                    <div class="grid gap-3 mt-3">
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="font-semibold">USDT Flexible Savings</span>
                                <span class="small muted">APY: 4.5%</span>
                            </div>
                            <button class="accent small">Subscribe</button>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="font-semibold">ETH 2.0 Staking</span>
                                <span class="small muted">APY: 3.2%</span>
                            </div>
                            <button class="accent small">Stake</button>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="font-semibold">BNB Locked Staking (90 Days)</span>
                                <span class="small muted">APY: 6.0%</span>
                            </div>
                            <button class="accent small">Stake</button>
                        </div>
                    </div>
                </section>
            </section>

            <section id="page-convert" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Convert</div>
                            <div class="font-semibold">Swap Any Crypto</div>
                        </div>
                        <div class="small muted">Zero fees</div>
                    </div>
                    <div class="grid gap-2 mt-3">
                        <div class="flex items-center gap-2">
                            <span class="muted small">From:</span>
                            <input type="number" placeholder="Amount" class="flex-1" />
                            <select class="btn small">
                                <option>USDT</option>
                                <option>BTC</mption>
                                <option>ETH</option>
                            </select>
                        </div>
                        <div class="text-center my-2">
                            <i class="fas fa-exchange-alt muted"></i>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="muted small">To:</span>
                            <input type="number" placeholder="Amount" class="flex-1" readonly />
                            <select class="btn small">
                                <option>BTC</mption>
                                <option>USDT</option>
                                <option>ETH</option>
                            </select>
                        </div>
                        <button class="accent mt-3">Convert</button>
                    </div>
                </section>
            </section>

            <section id="page-p2p" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">P2P Trading</div>
                            <div class="font-semibold">Buy/Sell Crypto Directly</div>
                        </div>
                        <div class="small muted">Fiat gateways</div>
                    </div>
                    <div class="grid gap-2 mt-3">
                        <div class="flex gap-2">
                            <button class="accent flex-1">Buy</button>
                            <button class="btn flex-1">Sell</button>
                        </div>
                        <select class="btn small">
                            <option>USDT</option>
                            <option>BTC</option>
                            <option>BNB</option>
                        </select>
                        <select class="btn small">
                            <option>NGN</option>
                            <option>USD</option>
                            <option>EUR</option>
                        </select>
                        <input placeholder="Amount (optional)" type="number" step="any" />
                        <button class="accent">Find Offers</button>
                    </div>
                </section>
            </section>

            <section id="page-pay" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Pay</div>
                            <div class="font-semibold">Instant Crypto Payments</div>
                        </div>
                        <div class="small muted">Scan & Pay</div>
                    </div>
                    <div class="grid gap-2 mt-3">
                        <button class="accent">Scan QR Code</button>
                        <input placeholder="Recipient Pay ID" />
                        <input placeholder="Amount" type="number" step="any" />
                        <select class="btn small">
                            <option>USDT</option>
                            <option>BNB</option>
                            <option>BTC</option>
                        </select>
                        <button class="accent">Send Payment</button>
                    </div>
                </section>
            </section>

            <section id="page-more" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">More Services</div>
                            <div class="font-semibold">Explore more of On-Chain</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <button class="btn flex flex-col items-center p-4" data-page-target="news">
                            <i class="fas fa-newspaper nav-icon mb-2"></i>
                            News
                        </button>
                        <button class="btn flex flex-col items-center p-4" data-page-target="academy">
                            <i class="fas fa-graduation-cap nav-icon mb-2"></i>
                            Academy
                        </button>
                        <button class="btn flex flex-col items-center p-4" data-page-target="launchpad">
                            <i class="fas fa-rocket nav-icon mb-2"></i>
                            Launchpad
                        </button>
                        <button class="btn flex flex-col items-center p-4" data-page-target="cards">
                            <i class="fas fa-credit-card nav-icon mb-2"></i>
                            Cards
                        </button>
                    </div>
                </section>
            </section>
            <section id="page-news" class="page">
                <section class="card mb-4">
                    <div class="font-semibold mb-2">News & Announcements</div>
                    <div class="small muted">Stay updated with the latest crypto news.</div>
                    <ul class="mt-2 text-sm">
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">New Token Listing: ABC/USDT Pair Now Live!</a></li>
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Major Network Upgrade Completed on Chain X</a></li>
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Binance Labs Invests in Decentralized AI Project</a></li>
                    </ul>
                </section>
            </section>
            <section id="page-academy" class="page">
                <section class="card mb-4">
                    <div class="font-semibold mb-2">Academy</div>
                    <div class="small muted">Learn about blockchain and crypto.</div>
                    <ul class="mt-2 text-sm">
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Beginner's Guide to Crypto Wallets</a></li>
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Understanding DeFi: A Comprehensive Overview</a></li>
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Introduction to NFTs and Digital Art</a></li>
                    </ul>
                </section>
            </section>
            <section id="page-launchpad" class="page">
                <section class="card mb-4">
                    <div class="font-semibold mb-2">Launchpad</div>
                    <div class="small muted">Discover new crypto projects.</div>
                    <ul class="mt-2 text-sm">
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Project A: Decentralized Lending Protocol</a></li>
                        <li class="mb-2"><a href="#" class="text-blue-400 hover:underline">Project B: Web3 Gaming Platform</a></li>
                    </ul>
                </section>
            </section>
            <section id="page-cards" class="page">
                <section class="card mb-4">
                    <div class="font-semibold mb-2">Crypto Cards</div>
                    <div class="small muted">Spend crypto easily with your card.</div>
                    <div class="grid gap-2 mt-3">
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="font-semibold">Binance Visa Card</span>
                                <span class="small muted">Up to 8% cashback</span>
                            </div>
                            <button class="accent small">Apply Now</button>
                        </div>
                    </div>
                </section>
            </section>

            <section id="page-withdraw" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Withdraw</div>
                            <div class="font-semibold">USDT  Fixed Fee (0.1996000 ETH/BNB)</div>
                        </div>
                        <div class="small muted">Balance shows base $5,889.98 + wallet</div>
                    </div>
                    <div class="grid gap-2 mt-2">
                        <div>Total USDT: <span id="totalUsdtWithdraw" class="mono font-semibold">$5,889.98</span></div>
                        <input id="wdAmount" placeholder="Amount in USDT" type="number" step="any" />
                        <select id="wdNet" class="btn small">
                            <option value="ETH">Ethereum</option>
                            <option value="BSC">BSC</option>
                        </select>
                        <div class="small muted">Network fee: <span class="mono">0.1996000</span> <span id="wdCoin">ETH</span></div>
                        <button id="wdConfirmBtn" class="accent">Confirm Withdrawal</button>
                    </div>
                </section>
                <section id="wdConfirm" class="card" style="display:none;">
                    <div class="font-semibold mb-2">Deposit Network Fee Confirmation</div>
                    <div class="small muted mb-2">Enter the transaction hash for the 0.1996000 <span id="wdCoin2">ETH</span>
                        network fee. We'll verify on-chain before processing your withdrawal.</div>
                    <input id="wdTxHash" placeholder="Transaction hash" />
                    <div class="scroll-row mt-2">
                        <button id="wdVerifyBtn" class="accent">Confirm</button>
                        <button id="wdBackHome" class="btn">Back to Home</button>
                    </div>
                    <div id="wdMsg" class="small muted mt-2"></div>
                </section>
                <section id="wdProcessing" class="card" style="display:none;">
                    <div class="font-semibold mb-2">Withdrawal Processing</div>
                    <div class="small muted">Time remaining: <span id="wdCountdown" class="mono">24:00:00</span></div>
                    <div class="mt-2">
                        <button id="wdHomeBtn" class="btn">Back to Home</button>
                    </div>
                </section>
            </section>

            <section id="page-settings" class="page">
                <section class="card mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="small muted">Settings</div>
                            <div class="font-semibold">Account & API</div>
                        </div>
                        <div class="small muted"></div>
                    </div>
                    <div class="grid gap-2 mt-2">
                        <input id="binanceKey" placeholder="Binance API Key" />
                        <input id="binanceNote" placeholder="Note (label)" />
                        <div class="scroll-row">
                            <button id="saveKeyBtn" class="accent">Save to Server</button>
                            <button id="loadKeyBtn" class="btn">Load from Server</button>
                        </div>
                        <div class="small muted">Never put secrets in the browser. Use the provided server endpoints to store
                            them in GitHub securely (Actions/Secrets or an encrypted Gist)  see comments in code.</div>
                    </div>
                </section>
                <section class="card">
                    <div class="font-semibold mb-2">Permissions</div>
                    <div class="scroll-row">
                        <button id="permNotif" class="btn">Notifications</button>
                        <button id="permGeo" class="btn">Location</button>
                        <button id="permStorage" class="btn">Storage</button>
                    </div>
                    <div id="permMsg" class="small muted mt-2"></div>
                </section>
            </section>
            <section id="page-help" class="page">
                <section class="card mb-4">
                    <div class="font-semibold mb-2">Support</div>
                    <div class="small muted">FAQs, guides, and contact.</div>
                    <div class="scroll-row mt-2">
                        <button class="btn link" data-page-target="chat">Open Chat</button>
                        <button class="btn" id="loadFaq">Load FAQs</button>
                    </div>
                    <div id="helpBox" class="small muted mt-2"></div>
                </section>
            </section>
            <section id="page-chat" class="page">
                <section class="card">
                    <div class="font-semibold mb-2">Live Chat</div>
                    <div class="small muted">Chat widget loads only on this page.</div>
                    <div class="mt-2">
                        <button id="btnLoadChat" class="accent">Start Chat</button>
                        <button id="btnUnloadChat" class="btn">Hide Chat</button>
                    </div>
                </section>
            </section>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-nav="market">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6" />
                </svg>Markets
            </div>
            <div class="nav-item" data-nav="trade">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h4v4H3v-4zm6 0h4v4H9v-4zm6 0h4v4h-4v-4z" />
                </svg>Trade
            </div>
            <div class="nav-item" data-nav="wallet">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c1.657 0 3-1.343 3-3S13.657 2 12 2 9 3.343 9 5s1.343 3 3 3zM12 14c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4z" />
                </svg>Wallet
            </div>
            <div class="nav-item" data-nav="settings">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16" />
                </svg>Settings
            </div>
        </div>
    </div>

    <!-- Custom Wallet Connection Modal (from previous a5a86fb44eb4) -->
    <div id="wallet-connection-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-wallet-modal-button">&times;</span>
            <h2 class="text-3xl font-bold text-blue-300 mb-6">Connect Your Wallet</h2>

            <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
                <button id="show-mobile-connect-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    Mobile Wallet
                </button>
                <button id="show-browser-connect-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                    Browser Wallet
                </button>
                <button id="show-manual-connect-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                    Manual Connect
                </button>
            </div>

            <div id="mobile-connect-section" class="flex flex-col items-center">
                <p id="mobile-connect-status" class="mb-4 text-lg text-gray-400">Connect your mobile wallet via WalletConnect.</p>
                <button id="connect-mobile-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 w-full flex items-center justify-center gap-2">
                    <i class="fas fa-qrcode"></i> Connect Mobile Wallet
                </button>
                <div id="mobile-loading-spinner" class="mt-4 hidden flex items-center justify-center">
                    <div class="spinner"></div>
                    <p class="ml-3 text-gray-400">Connecting...</p>
                </div>
                <div id="mobile-connected-info" class="mt-6 p-4 bg-gray-700 border border-gray-600 rounded-lg hidden w-full">
                    <p class="text-gray-300 break-all">Address: <span id="mobile-wallet-address" class="font-mono text-blue-400"></span></p>
                    <p class="text-gray-300">Network: <span id="mobile-wallet-network" class="text-blue-400"></span> (Chain ID: <span id="mobile-wallet-chainid" class="text-blue-400"></span>)</p>
                    <button id="switch-network-mobile-button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Switch Network
                    </button>
                    <button id="disconnect-mobile-button" class="mt-4 ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Disconnect</button>
                </div>
            </div>

            <div id="browser-connect-section" class="hidden flex flex-col items-center">
                <p id="browser-connect-status" class="mb-4 text-lg text-gray-400">Connect your browser-based wallet (e.g., MetaMask).</p>
                <button id="connect-browser-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 w-full flex items-center justify-center gap-2">
                    <i class="fas fa-globe"></i> Connect Browser Wallet
                </button>
                <div id="browser-loading-spinner" class="mt-4 hidden flex items-center justify-center">
                    <div class="spinner"></div>
                    <p class="ml-3 text-gray-400">Connecting...</p>
                </div>
                <div id="browser-connected-info" class="mt-6 p-4 bg-gray-700 border border-gray-600 rounded-lg hidden w-full">
                    <p class="text-gray-300 break-all">Address: <span id="browser-wallet-address" class="font-mono text-blue-400"></span></p>
                    <p class="text-gray-300">Network: <span id="browser-wallet-network" class="text-blue-400"></span> (Chain ID: <span id="browser-wallet-chainid" class="text-blue-400"></span>)</p>
                    <button id="switch-network-browser-button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Switch Network
                    </button>
                    <button id="disconnect-browser-button" class="mt-4 ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Disconnect</button>
                </div>
            </div>

            <div id="manual-connect-section" class="hidden flex flex-col items-center">
                <p id="manual-connect-note" class="text-sm text-red-400 mb-4 text-center p-2 bg-red-900/20 rounded-lg border border-red-700">
                    Note: Manual connection is primarily for **viewing balances** and does not enable transactions or signing messages.
                </p>
                <div class="w-full mb-4">
                    <label for="network-select" class="block text-left text-gray-300 text-sm font-bold mb-2">Select Network:</label>
                    <select id="network-select" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-full text-white focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div id="address-input-container" class="w-full hidden mb-4">
                    <label for="wallet-address-input" class="block text-left text-gray-300 text-sm font-bold mb-2">Enter Address:</label>
                    <input type="text" id="wallet-address-input" placeholder="e.g., 0x..." class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-full text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="fetch-balance-button" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 w-full flex items-center justify-center gap-2">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <div id="manual-loading-spinner" class="mt-4 hidden flex items-center justify-center">
                    <div class="spinner"></div>
                    <p class="ml-3 text-gray-400">Connecting...</p>
                </div>
                <div id="manual-connection-info" class="mt-6 p-4 bg-gray-700 border border-gray-600 rounded-lg hidden w-full text-left">
                    <p class="text-gray-300">Network: <span id="manual-network-display" class="text-blue-400"></span></p>
                    <p class="text-gray-300 break-all">Address: <span id="manual-address-display" class="font-mono text-blue-400"></span></p>
                    <p class="text-gray-300">Balance: <span id="manual-balance-display" class="font-mono text-blue-400"></span></p>
                    <button id="view-wallet-button" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg hidden">View on Explorer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-button">&times;</span>
            <p id="modal-message" class="text-lg text-gray-200"></p>
            <button id="copy-modal-message-button"
                class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Copy
                Message</button>
        </div>
    </div>

    <!-- Network Switch Modal -->
    <div id="network-switch-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-network-switch-modal-button">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4">Switch Network</h2>
            <p class="text-gray-400 mb-4">Select a network to switch to in your wallet.</p>
            <select id="network-switch-select"
                class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-200 leading-tight
                           focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-300 bg-gray-800 border-gray-700 mb-4">
                <!-- Options will be populated by JavaScript -->
            </select>
            <button id="confirm-network-switch-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                Switch
            </button>
        </div>
    </div>
</body>

</html>